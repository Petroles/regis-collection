<?xml version="1.0" encoding="utf-8"?>
<add>
	<doc>
		<field name="docid">BR-TU.18343</field>
		<field name="filename">25250_ulfc118679_tm_Vanessa_Pita.pdf</field>
		<field name="filetype">PDF</field>
		<field name="text">
UNIVERSIDADE DE LISBOA 

FACULDADE DE CIÊNCIAS 

DEPARTAMENTO DE FÍSICA 

 

 

 

 

 

Monte Carlo LINAC Simulations using PRIMO 

for IMRT Treatment Verification 

 

Mestrado Integrado em Engenharia Biomédica e Biofísica 

Perfil de Radiações em Diagnóstico e Terapia 

 

Vanessa Cristina Inácio Pita 

 

Dissertação orientada por: 

Professor Doutor João Miranda Santos 

Professor Doutor Luís Filipe Peralta 

 

 

2016



i 
 

Acknowledgments 
 

The realization of this project was an achievement to my professional life as much as 

it was an experience for my personal life. I would like to express my sincere gratitude to all of 

those who made it possible and helped me to overcome all the adversities. 

Dr. João Santos, I would like to thank you for the opportunity to join me in Medical 

Physics, Radiobiology and Radiation Protection Group, in Porto IPO Research Center (CI-IPO); 

and also  for guiding me in this project, being always available and motivating me with your 

enthusiasm for this subject.  

Dr. Anabela Dias, thank you for the supervision provided in partnership with Dr. João 

and for all the help given. 

Alessandro, the huge knowledge in Monte Carlo and your ideas were an asset for this 

work. Thank you so much for sharing them with me and for always making things look simpler 

than I figured.  

Bruno, Fábio, Filipa, Filipe, Rafael, Rita, Susana, e Vera, ex- interns of the service and 

frequent presence in laboratory 2, a big thank you to everyone. Without you my adaptation 

process to IPO would have not been so easy. Thank you for the affection, for the concern and 

for the friendship and all the good moments we shared, I will never forget each of you. 

Dra Joana, Diana, Sofia and all the Medical Physics Department of Porto IPO, with no 

exception, you were incredible to me. Thank you for your friendliness, for always being very 

helpful to me, and for welcoming me so openly. 

Professor Luis Peralta, I am thankful to you for being my internal supervisor and also 

for your availability and concern. 

Sofia, Sílvia, Raquel and Débora, my dear friends, thank you very much for your 

regular presence in my life in Porto and for always being with me. 

My dear Fábio, your strength and unconditional support in the final phase of this 

project was crucial to me. Therefore, an enormous “thank you” for always believed in me. 

Irene, Paulo, João and my whole family, I have no words to express my gratitude to 

you, for all you have done for me. Without your support, none of this would have been 

possible. 

  



ii 
 

Resumo 
 

As simulações de Monte Carlo são consideradas o método mais eficiente para 

executar cálculos de dose absorvida em radioterapia externa, porque fornecem uma descrição 

muito detalhada e completa dos campos de radiação e do transporte de partículas nos tecidos. 

Existem atualmente vários códigos de Monte Carlo neste contexto, mas este trabalho focar-se-

á no PRIMO. O principal objetivo com o desenvolvimento deste projeto é mostrar que o 

PRIMO é uma ferramenta com enorme potencial para simular tratamentos de IMRT, e que por 

esta razão pode ser muito útil na verificação clínica destes tratamentos. 

A radioterapia de intensidade modulada (IMRT, do inglês Intensity-Modulated 

Radiation Therapy), resulta da evolução da técnica de radioterapia conformacional 

tridimensional (3D-CRT, do inglês Three-Dimensional Conformal Radiotherapy). Esta veio 

acrescentar à conformação geométrica do feixe de radiação, a capacidade de modulação da 

intensidade do mesmo. Por ser extremamente precisa a aplicação de um feixe de radiação 

nesta técnica, é possível aplicarem-se elevadas doses de radiação ao tumor, preservando ao 

máximo os tecidos saudáveis. Contudo, esta técnica requer um planeamento mais complexo e 

um maior número de profissionais envolvidos desde o planeamento até à execução do 

tratamento.  

Antes de ser efetuado um tratamento de IMRT é necessário fazer uma verificação 

precisa da dose que será administrada ao paciente, recorrendo a ferramentas de garantia do 

controlo da qualidade. Com estas, são comparadas as distribuições de dose adquiridas com um 

fantôma com as simuladas no sistema de planeamento do tratamento. Para que o tratamento 

seja aplicado a um paciente, é necessário que a compatibilidade seja superior a 95%, utilizando 

um índice gama a 3% e 3mm, o que não ocorre sempre. Quando este nível de concordância 

não é atingido é necessário analisar o que influenciou esse resultado, e por vezes refazer o 

plano de tratamento, sem que grandes conclusões acerca desta não concordância sejam 

apontadas. Uma vez que, para realizar estes testes, é utilizada uma matriz com várias câmaras 

de ionização separadas entre si, neste caso em concreto, uma matriz com 729 câmaras de 

ionização separadas por 1 cm, é associado a esta medição um dado erro. Este erro poderá 

estar, por vezes, na origem da não concordância entre o planeamento efetuado e a sua 

irradiação num fantoma. Por esta razão, nestas situações, seria interessante a existência de 

um método alternativo de teste para contrapor estes resultados, como por exemplo aqueles 

que têm por base os cálculos de Monte Carlo, tal como é o caso do PRIMO. 

O PRIMO é um programa de simulações de Monte Carlo, que tem por base o código 

PENELOPE. Este permite que sejam calculadas distribuições de dose em fantômas ou num 



iii 
 

paciente, com a precisão característica dos métodos de Monte Carlo. Contudo, contrariamente 

ao que acontece com a maioria dos programas de Monte Carlo, o PRIMO apresenta a 

particularidade de ter uma interface gráfica muito apelativa ao utilizador, sendo muito 

intuitivo, e por isso de fácil utilização. Este programa permite escolher o acelerador linear a 

utilizar, recorrendo a uma base de dados disponibilizada pela IAEA, e definir muitos outros 

fatores (energia nominal, SSD, tamanho do campo, etc.), tal como ocorre aquando de uma 

aquisição de distribuições de dose num fantôma. É por este motivo, que se acredita que este 

programa poderá ser um ótimo complemento à verificação e aprovação de tratamentos de 

IMRT, tendo sido esta razão pela qual o programa foi escolhido para realizar este trabalho.  

Tratando-se de um programa bastante recente, a primeira etapa deste trabalho 

consistiu na validação do mesmo para os aceleradores utilizados. Este processo consistiu na 

comparação das curvas de dosimetria básica: o perfil que mostra a percentagem de dose em 

profundidade (PDD, do inglês Percentage Depth Dose), e ainda os perfis transversais X e Y.  

Na prática, estas curvas são medidas diretamente num LINAC, utilizando um tanque de 

água para a sua aquisição e os seus resultados foram usados para a comparação com os dados 

simulados. Esta medição é efetuada a cada 6 meses (ou sempre que haja intervenções no 

acelerador que as justifiquem), no sentido de verificar se as curvas medidas se encontram 

dentro dos parâmetros aceitáveis, por comparação às curvas obtidas aquando da instalação do 

LINAC e sua consequente aceitação (processo designado comummente por commissioning). 

Para escolher as curvas a usar na validação do programa, foi realizado um estudo sobre a sua 

evolução ao longo do tempo, que resultou na escolha do PDD e perfis laterais obtidos na 

aceitação do aparelho.  

No PRIMO, estas curvas foram simuladas, para o mesmo aparelho utilizado nas 

medições práticas, num fantoma equivalente ao tanque de água, já existente no programa. O 

LINAC escolhido para este estudo foi um CLINAC 2300 da Varian, por ser um aparelho existente 

no serviço de Radioterapia do IPO do Porto e também no PRIMO. A validação foi um processo 

efetuado por tentativa e erro. A cada simulação se alterava um dado parâmetro (energia 

inicial, focal spot, técnica de redução da variância, etc.). Quando terminava a simulação, o PDD 

e perfis laterais eram comparados com as curvas já selecionadas. Se os resultados não 

apresentassem um grau de concordância de 95% ou mais, segundo o índice gama a 2% e 2mm, 

alterava-se um parâmetro e refazia-se a simulação. Quando os resultados simulados 

apresentaram boa concordância, o programa foi validado e o trabalho prosseguiu, rumo ao seu 

objetivo final. Relativamente a este método de comparação, é pertinente referir que este 

índice gama é o critério de comparação também utilizado na prática clínica, embora nesse 

contexto se use o índice gama para 3% e 3 mm. 



iv 
 

A comparação das curvas de dosimetria básica simuladas e medidas foi realizada 

diretamente no PRIMO, nesta etapa inicial. Contudo, para se poder progredir neste trabalho 

seria necessário comparar imagens e não curvas, isto é comparar distribuições de dose 2D/3D 

em vez de 1D, o que não é possível usando o PRIMO. Por esta razão, os resultados obtidos nas 

simulações com o PRIMO tiveram de ser exportados e transformados em imagens DICOM, com 

o auxílio de funções criadas utilizando o Matlab, para que se pudesse realizar as comparações 

utilizando outro programa. O programa mais usado neste contexto foi o Verisoft, que é o 

programa utilizado nas comparações efetuadas aquando da verificação dos tratamentos de 

IMRT. 

A segunda etapa consistiu na adição do MLC aos campos simulados e, na sua 

consequente, validação. Para isso, foi simulado um campo 10x10 cm
2
 com um MLC estático 

tendo uma dada conformação. Esse campo simulado pelo PRIMO foi comparado com o mesmo 

campo simulado pelo TPS, e também com o mesmo campo irradiado no LINAC. No final, as três 

modalidades foram comparadas entre si e todas tinham de ser compatíveis, segundo os 

mesmos critérios de comparação do índice gama. Quando essa compatibilidade foi 

encontrada, considerou-se o MLC validado e passou-se à fase seguinte.  

O último passo neste projeto foi a simulação de um campo 10x10 cm
2
 com MLC 

dinâmico. Este passo é equivalente a fazer a simulação de um campo de IMRT na técnica que 

utiliza o MLC por segmentos. Nesta fase foi preciso compilar 89 campos que, no final, 

perfizeram um campo de IMRT. Esse campo simulado foi, à semelhança do ocorrido 

anteriormente, comparado também com a sua simulação pelo TPS e irradiação no LINAC. Uma 

vez verificada uma compatibilidade de 96% entre o campo simulado e medido, para um índice 

gama a 2% e 2mm, ficou demonstrada a potencialidade do programa para simular tratamentos 

de IMRT usando simulações de Monte Carlo. 

Este projeto foi um estudo preliminar à simulação de tratamentos de IMRT usando o 

PRIMO, no qual, no final, se conseguiu simular um plano de IMRT com sucesso, pois este 

apresentou uma concordância aceitável com os resultados experimentais. Apesar de este 

trabalho ter muito por onde ser continuado, pois estudos mais aprofundados sobre os 

tratamentos mais complexos são necessários, os resultados corroboram a tese de o PRIMO ser 

uma ferramenta muito promissora para a simulação de tratamentos de IMRT em ambiente 

clínico, em especial na garantia de qualidade dos mesmos. 

 

Palavras-chave: Radioterapia; IMRT; Simulações de Monte Carlo; PRIMO; Teste do índice 

gama.  



v 
 

Abstract 
 

Monte Carlo (MC) approach is considered the gold standard method to perform 

absorbed dose calculations in external radiotherapy because it provides the most detailed and 

complete description of radiation fields and particle transport in tissues. Several codes are 

available and recently a new MC Penelope based code and graphic platform named PRIMO 

was developed. PRIMO has a user-friendly approach, a suitable and competitive characteristic 

for clinical activity. Nevertheless, advanced features such as Intensity Modulated Radiotherapy 

(IMRT) are not introduced yet. The aim of this work is to have a preliminary result on the 

feasibility of MC simulation of IMRT procedures, making use of the PRIMO software, showing 

that it can be an useful tool in clinical verification of IMRT treatments. 

The first stage of this work was PRIMO validation for a Varian Clinac 2300, the same 

LINAC model used in practical acquisitions. This process consisted in comparing basic 

dosimetry curves acquired on LINAC using water tank with PRIMO simulations of them. Once 

Percentage Depth Dose (PDD) and lateral profiles X and Y simulated and acquired in practice 

showed compatibility higher than 95%, using the gamma index criteria with 2% and 2mm, the 

program is validated. 

After validation, Multileaf Collimator (MLC) was added and validated. To achieve this 

goal, a 10x10 cm
2
 field with a static MLC with a given conformation was simulated. This field 

simulated by PRIMO was compared to the same field simulated by the TPS, and also with the 

same field irradiated on LINAC. In the end, the three methods were compared and all had to 

be compatible, according to the same gamma index comparison criteria. When this 

compatibility was found, MLC was validated and the work could proceed to the next stage. 

The last step in this project was the simulation of a 10x10 cm
2
 field with dynamic 

MLC. At this stage it was necessary to build 89 fields that in the end, their sum make one IMRT 

field. As it had happened before, this simulated field was also compared with its simulation by 

TPS and its irradiation on LINAC. The compatibility between them was checked using the 

gamma index criteria of 2% and 2mm and it was found that 96% of the points were coincident. 

This fact demonstrated PRIMO capability to simulate IMRT treatments and consequently, IMRT 

treatments verification. 

 

Key words: Radiotherapy; IMRT; Monte Carlo Simulations; PRIMO; Gamma Index test. 

  



vi 
 

List of Communications 
 

Resulting from the work presented in this thesis a communication was presented in one of the 

most important conferences in radiotherapy around the world, organized by the European 

Society for Radiotherapy &amp;amp; Oncology (ESTRO), the ESTRO 35. Bellow is the communication 

bibliographic reference: 

 

? V. Pita, A. Esposito, A.G.Dias, J. Lencart, J.A.M. Santos, “PRIMO software as a tool for 

Monte Carlo treatment quality control in IMRT: a preliminary study”, poster 

presentation in ESTRO 35, Turin, Italy, April 2016.  

 

  



vii 
 

Acronyms 
  

AAA Anisotropic Analytical Algorithm 

CT Computed Tomography 

CTV Clinical Tumor Volume 

DCS Differential cross sections 

DICOM Digital Imaging and Communications in Medicine 

DVH Dose volume histogram 

EPID Electronic Portal Imaging Device 

FWHM Full width at half maximum 

GTV Gross tumor volume 

IAEA International Atomic Energy Agency 

IMRT Intensity Modulated Radiation Therapy 

LINAC Linear accelerator 

MC Monte Carlo 

MLC Multi Leaf Collimator 

MRI Magnetic Resonance Imaging 

MU Monitor Units 

OAR Organ at risk 

PBC Pencil Beam Convolution 

PDD Percentage Depth Dose 

PET Positron Emission Tomography 

PHSP Phase-space 

PTV Planning Tumor Volume 

QA Quality Assurance 

SBRT Stereotactic Body Radiotherapy  

SRS Stereotactic Radiosurgery  

SRT Stereotactic Radiotherapy  

SSD Source to Surface Distance 

TPS Treatment Planning System 

VRT Variance Reduction Technique 

 

 

  



viii 
 

List of Figures 
 

Figure 2.1 – Diagram of a linear accelerator in photon mode [10]. .............................................. 6 

Figure 2.2 – Multileaf collimator [12]. .......................................................................................... 7 

Figure 2.3  – Main components of a LINAC [11]. .......................................................................... 8 

Figure 2.4 - Basic design of a cylindrical Farmer type ionization chamber [15]. ........................... 9 

Figure 2.5 – Water tank phantom for basic dosimetry[18]......................................................... 10 

Figure 2.6 – Geometrical PDD definition.  Q is an arbitrary point at depth Z and P is the point at 

Zmax. A corresponds to the field size [11]. ................................................................................... 11 

Figure 2.7 – PDD curves in water for various photon beams at SSD of 100 cm [11]. ................. 11 

Figure 2.8 – Beam profiles of 10 MV at various depths in water, for field sizes of 10 cm x 10 cm 

and 30 cm x 30 cm[11]. ............................................................................................................... 12 

Figure 2.9 – a) 3D Conformal RT technique using uniform beams; b) IMRT technique using non 

uniform beams [17]. .................................................................................................................... 15 

Figure 2.10 – Beam incidence and dose color wash on 3D-CRT (on the left) and Beam incidence 

and dose color wash on IMRT(on the right) [21]. ....................................................................... 15 

Figure 2.11 – Solid water phantom used in IMRT treatments quality control [45]. ................... 21 

Figure 2.12 – Scheme that has all the components of PRIMO [55]. ........................................... 23 

Figure 3.1 – PRIMO window that opens when new Project is selected...................................... 28 

Figure 3.2 – Parameters of Segment 1. ....................................................................................... 28 

Figure 3.3 – Variance reduction configuration for s1. ................................................................ 29 

Figure 3.4 – Simulation configuration. ........................................................................................ 29 

Figure 3.5 - Parameters of Segment 2. ........................................................................................ 30 

Figure 3.6 – Configuration of the irradiation field. ..................................................................... 31 

Figure 3.7 - Parameters of Segment 3. ........................................................................................ 31 

Figure 3.8 - Variance reduction configuration for s3. ................................................................. 32 

Figure 3.9 – Solid water phantom used in IMRT treatments quality control in Porto IPO being 

mounted on the LINAC table for a verification procedure. ........................................................ 35 

Figure 3.10 – PTW matrix of 27 x 27 cm
2
 formed by 729 ionization chambers, spaced by 1 cm, 

which is used in the solid water phantom at IMRT treatments quality control [45]. ................. 35 

Figure 3.11 – MLC static configuration. ...................................................................................... 37 

Figure 3.12 – Example of Dynamic IMRT divided into 89 static MLC shaped fields. .................. 37 

Figure 3.13 – Simulation Setup. The red mark indicates the isocenter placed at the center of 

the ion chamber array. The isocenter is at 100 cm distance from the beam source. The 



ix 
 

numerical voxelized phantom is created by the internal conversion tool of PRIMO, once the CT 

scan calibration curve is introduced. .......................................................................................... 38 

Figure 4.1 - Maximum dose depth. ............................................................................................. 40 

Figure 4.2 – Flatness over the years for lateral profile X. ........................................................... 41 

Figure 4.3 – Symmetry over the years for lateral profile X. ........................................................ 41 

Figure 4.4 - Flatness over the years for lateral profile Y. ............................................................ 42 

Figure 4.5 - Symmetry over the years for lateral profile Y. ......................................................... 42 

Figure 4.6 – Number of histories in function of the simulation time. ........................................ 44 

Figure 4.7 – PDDs from simulations with the same conditions but with different time as stop 

criteria. A – PDD from simulation with 1.97 x 10
6
 histories. B – PDD from simulation with 9.37 x 

10
6
 histories. ................................................................................................................................ 45 

Figure 4.8 – Percentage of passing points in function of the number of histories. .................... 46 

Figure 4.9 - Percentage of passing points as function of the energy. ......................................... 47 

Figure 4.10 – Illustration of lateral profile variation when increasing focal spot. ...................... 48 

Figure 4.11 - Percentage of passing points in function of splitting factor. ................................. 49 

Figure 4.12 - Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding 

PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% of the points 

was lower than 1. ........................................................................................................................ 50 

Figure 4.13 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and 

corresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 

90.54% of the points was lower than 1. ...................................................................................... 50 

Figure 4.14 – Phantom Setup. ..................................................................................................... 50 

Figure 4.15 – Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding 

PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 99.66% of the points 

was lower than 1. ........................................................................................................................ 51 

Figure 4.16 – Comparison between Clinac 2300 (DHX5) lateral profile X from 2011 and 

corresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% 

of the points was lower than 1. .................................................................................................. 52 

Figure 4.17 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and 

corresponding PRIMO simulation. The gamma function analysis (2%, 2mm) showed that 100% 

of the points was lower than 1. .................................................................................................. 52 

Figure 4.18 – PRIMO simulation results. ..................................................................................... 54 

Figure 4.19 – Image output created by MATLAB from PRIMO notepad document. .................. 54 

Figure 4.20 - Comparison between PRIMO simulation and LINAC irradiation of an open field. 55 

Figure 4.21 - Comparison between PRIMO simulation and TPS of an open field. ...................... 56 



x 
 

Figure 4.22- Comparison between TPS and LINAC irradiation of an open field. ........................ 57 

Figure 4.23 – Comparison between PRIMO simulation and TPS of a static MLC field. ............... 58 

Figure 4.24 - Comparison between PRIMO simulation and LINAC irradiation of a static MLC 

field. ............................................................................................................................................. 59 

Figure 4.25 - Comparison between TPS and LINAC irradiation of a static MLC field. ................. 60 

Figure 4.26 – Gafchromic film after the dynamic field irradiation.............................................. 61 

Figure 4.27 – 2D Comparison obtained in Doselab between dynamic field measured with a 

gafchromic film and with the same measurement in ion chamber matrix. The gamma function 

analysis (3%, 3mm) showed that 98.8% of the points was lower than 1. .................................. 61 

Figure 4.28 – A - Dose distribution for the dynamic IMRT treatment, measured with ionization 

chamber array, placed at 100 cm distance from the LINAC head under 5 cm of water 

equivalent. B – Dose distribution at the matrix for the simulated dynamic plan. C - Comparison 

between PRIMO simulation and LINAC irradiation of a dynamic MLC field. .............................. 62 



xi 
 

Table of Contents 
 
Acknowledgments .......................................................................................................................... i 

Resumo .......................................................................................................................................... ii 

Abstract ......................................................................................................................................... v 

List of Communications .................................................................................................................vi 

Acronyms ...................................................................................................................................... vii 

List of Figures .............................................................................................................................. viii 

Table of Contents .......................................................................................................................... xi 

1 Introduction .......................................................................................................................... 1 

1.1 Motivation ..................................................................................................................... 1 

1.2 Intensity modulated radiotherapy (IMRT) .................................................................... 2 

1.3 Monte Carlo LINAC simulation ...................................................................................... 3 

1.4 Objectives of this work .................................................................................................. 5 

2 Experimental and theoretical background ............................................................................ 6 

2.1 Linear Accelerators ........................................................................................................ 6 

2.2 Dose measurement ....................................................................................................... 8 

2.3 Phantoms for basic dosimetry ...................................................................................... 9 

2.4 Percentage Depth Dose (PDD) .................................................................................... 10 

2.5 Lateral Profiles acquisition and characterization ........................................................ 11 

2.5.1 Flatness ................................................................................................................ 12 

2.5.2 Symmetry ............................................................................................................ 13 

2.6 Modern Radiotherapy Techniques .............................................................................. 13 

2.6.1 3DCRT .................................................................................................................. 13 

2.6.2 IMRT .................................................................................................................... 13 

2.6.3 Volumetric Modulated Arc Therapy - VMAT ....................................................... 15 

2.6.4 Tomotherapy ....................................................................................................... 16 

2.6.5 SRS, SRT and SBRT ............................................................................................... 16 

2.6.6 Treatment monitoring ......................................................................................... 16 

2.6.7 Image guided patient positioning techniques ..................................................... 17 

2.7 Treatment Planning System (TPS) ............................................................................... 17 

2.7.1 Treatment planning ............................................................................................. 17 

2.7.2 Dose calculation algorithms ................................................................................ 18 

2.7.3 Isodose distributions ........................................................................................... 19 



xii 
 

2.7.4 Dose distribution verification techniques ........................................................... 20 

2.8 Phantoms for IMRT verification .................................................................................. 20 

2.9 Monte Carlo dose distribution calculations ................................................................ 21 

2.10 PRIMO (Penelope based MC code) ............................................................................. 23 

2.11 Use of Gamma Index function for MC simulations validation .................................... 24 

3 Methodology ....................................................................................................................... 26 

3.1 Basic Dosimetry ........................................................................................................... 26 

3.1.1 Basic Dosimetry Curve Analysis ........................................................................... 26 

3.2 PRIMO Simulation ....................................................................................................... 27 

3.3 PRIMO validation ......................................................................................................... 32 

3.4 PRIMO output problem ............................................................................................... 33 

3.5 Quality Assurance (QA) Test ........................................................................................ 34 

3.6 MLC Tests .................................................................................................................... 36 

4 Results and Discussion ........................................................................................................ 39 

4.1 Basic Dosimetry Curves Analysis ................................................................................. 39 

4.2 PRIMO validation ......................................................................................................... 43 

4.3 PRIMO output problem ............................................................................................... 53 

4.4 MLC Tests .................................................................................................................... 54 

5 Conclusions and Future Work ............................................................................................. 63 

Bibliography ................................................................................................................................ 67 

Appendices ..................................................................................................................................... i 

Appendix A .................................................................................................................................... ii 

A.1.  Functions to write a new PRIMO file ................................................................................ ii 

A.2. Functions to read and interpret PRIMO files using a slab phantom in the simulation ......iv 

A.2. Functions to read and interpret PRIMO files using a CT image in the simulation ............. x 

 



1 
 

1 Introduction 
 

1.1 Motivation 
 

IMRT is a technique that has been progressively implemented since the 90s, in the 

United States and in Europe. Initially, it started as a technique only used in international 

reference institutions, but nowadays a number of smaller radiotherapy departments have it 

also implemented. In Portugal, the scenario is not different, with IMRT being implemented in 

more and more hospitals. This is a technique that allows the geometric conformation of the 

radiation beam to the target volume with a high accuracy. Simultaneously, it allows the 

modulation of the beam intensity, which creates fluence maps according to different tumor 

activity [1]. Thus, the results of IMRT clinical application were promising, with direct impact on 

the improvement of patient's life quality, decreasing some adverse effects of therapy [2]. 

However, IMRT treatments needs supplementary quality assurance tests before its 

application on patients, in addition to those necessary in other conventional radiotherapy 

techniques. These tests have as goal the comparison between the plans calculated by the 

treatment planning system (TPS) with its application to a phantom. Thus, the compatibility 

between them is estimated. The agreement between them is calculated based on the gamma 

index. If compatibility is higher than 95%, to a gamma index on 3% and 3mm, the treatment is 

approved. 

Sometimes this compatibility is not achieved and, in some cases, there is no apparent 

reason to that. The usage of matrix detectors to the practical acquisition of dose fluence is 

pointed out as possible cause for this incompatibility, because the matrix has spaces with no 

detectors. In IPO Porto is used a PTW 27x27 matrix, which has 729 ionization chambers spaced 

by 1 cm. The spaces between chambers have to be interpolated which can be an error source. 

For this reason, more accurate systems to calculate the applied dose profiles would be helpful 

in this situation.  

Nowadays, Monte Carlo simulations are pointed out as one of the most accurate 

methods to calculate dose distributions in radiotherapy, because of the high range of samples, 

which allows a dose calculation very close to reality. However, these methods require long 

time of computation and are not much user friendly. Recently, a new program of dose 

calculation using Monte Carlo, named PRIMO, was developed with the advantage of 

simplifying the calculation process to the users, becoming faster and user-friendly. PRIMO is an 

excellent tool of dose distribution calculation, which appears to be very useful in those cases of 



2 
 

IMRT treatment verification that are not compatible because no apparent reason. This fact 

arose as motivation for the development of this work, because it is believed that within this 

project interesting things about IMRT treatments simulation with Monte Carlo and about IMRT 

treatments verification could be found out, or at least, a big step in this direction.   

  

1.2 Intensity modulated radiotherapy (IMRT) 
 

Intensity Modulated Radiation Therapy (IMRT) is a high precision radiotherapy 

technique that enables the administration of high doses of radiation to the target volume, 

while minimizing the dose to normal surrounding tissue very effectively. This kind of dose 

distribution is achieved through application of several radiation beams with different incident 

angles and different radiation intensities. Thus, a non-uniform dose distribution is created, 

being conformed to the structures undergoing treatment, whether they are concave or convex 

[3]. When compared to conventional radiotherapy techniques, IMRT has the advantage of 

deliver higher intensity dose, minimizing the side effects in healthy tissues and organs 

surround. 

The treatment process begins with the planning Computed Tomography (CT) scan, 

which is sent to the 3D planning system, so that the medical oncologists could delineate the 

target volumes and organs at risk. In some cases other image modalities are needed to plan an 

IMRT treatment, such as Magnetic Resonance Imaging (MRI) or Positron Emission Tomography 

(PET), which are fused with the CT planning to help doctors to delineate the volumes of 

interest. 

In IMRT the plan is made by a technique called “inverse treatment planning”, which 

means that minimum and maximum doses, required for tumor control, are prescribed in the  

target volumes. The same thing happens to healthy tissues, in which are also prescribed 

maximum doses. Thus, the dose distribution fits precisely around the tumor or target volume, 

saving the healthy tissues. 

In general, this modality of radiotherapy uses about five to nine radiation fields 

oriented around the patient and administered by linear accelerators (LINAC) collimation 

systems with multiple leaves, which are called MLC (Multi Leaf Collimator). The dose 

distribution adapted to the volumes to treat is achieved because of the movement of the MLC 

leaves and because of the incidence angle of the beams [4], as already referred.  

It is a highly complex technique in which a large number of professionals are 

involved, such as radiation oncologists, dosimetrists, radiation technologists and medical 



3 
 

physicists. The complexity of the process involves a very accurate verification of the 

administered dose through quality checks performed by the medical physicists, for each plan, 

before apply it to a patient. These tests are performed using phantoms that are irradiated with 

the dose planed by dosimetrists in TPS. Then, the dose distribution obtained in the phantom is 

compared with the one calculated in TPS and if they are compatible, the planned treatment 

can be applied to the patient.  

 

1.3 Monte Carlo LINAC simulation 
 

Monte Carlo simulation is a statistical methodology that relies on a big random 

sampling to get similar results to reality. It allows you to experiment with variables a 

sufficiently large number of times to more accurately the chance of a result happen. 

In practice, whenever you come across situations with some level of uncertainty and 

want to use Monte Carlo simulation, you will have to go through four steps. First, a model of 

the problem is done. Second, random values are generated for the uncertainties of the 

problem. Then, the third step, the values uncertainties are replaced to calculate the result. 

Finally, the solution of the problem is estimated. With the evolution of these methods, their 

application was extended to several fields of study, as for example in radiotherapy. 

Monte Carlo simulations started to be used in radiotherapy dose calculations, 

becoming a common method to check other dose calculation methods in complex cases, 

where the simple methods were not able to work accurately. The development of a Monte 

Carlo beam model for linear accelerators (LINACs) was one of the first and most important 

step in Monte Carlo dose calculations. The calculation of the exact dose by Monte Carlo 

method requires accurate characterization of the radiation source [5]. 

To simulate the production of photon beams in a LINAC, the head components have to 

be precisely defined because they influence the output beam. Commonly, these components 

are the target, primary collimator and flattening filter, which have the greatest influence on 

the shape of the photon spectrum; and also the ionization chamber, the mirror and the 

secondary collimator. Information about components geometry and materials of the LINAC can 

be obtained from the manufacturer. 

To evaluate the dose distribution in a particular geometry, it is necessary that the state 

of particles in the incident beam is precisely known, i.e. energy, orientations and positions of 

photons, electrons and positrons. This data set is called phase space files (PHSP). Obtain a 

phase space in MC simulations of LINACs is achieved by defining a sensitive volume that stores 



4 
 

information about particles passing through. Generally, this volume is a thin circular cylinder 

that sits above the secondary collimator. In this case the phase space becomes a virtual LINAC 

and can be used in different simulations, paying attention if the amount of particles stored in 

the file is a sufficient sample to obtain the required precision.  

Phase space files (PHSP) are used as a primary generator in a simulation, which avoids 

the need for a detailed description of the geometry and materials, which are often a trade 

secret, and are rarely shared with the user`s machine. The availability of data PHSP also allows 

easy use of various beam qualities dosimetry studies, as detector characterization and the 

development of dose protocols. 

The International Atomic Energy Agency (IAEA) has promoted a project to build a 

database to make public representative PHSP files of linear accelerators (and Co-60 units) used 

in external radiotherapy, compiling the existing data that has been properly validated. The 

IAEA PHSP format was designed and approved by a committee of international experts for use 

in medical applications [6]. This format was implemented in newer versions of general purpose 

MC codes as BEAMnrc / EGSnrc and Penelope, which are considered the state of -the -art for 

the electron-photon transport engaged in medical applications[7]. More recently, a Penelope 

based computer software named PRIMO was created, which is  promising software in Monte 

Carlo LINAC simulation and will be used in this work. 

PRIMO project was released in 2013 and it is a program that simulates linear 

accelerators and estimated absorbed dose distributions in water phantoms and CT scans (in 

dicom format). This software combines an appealing graphical interface to the user with 

computation processes based on the Monte Carlo code PENELOPE. The most of Varian and 

Elekta LINACs can be simulated by PRIMO, including electron applicators and multileaf 

collimators (MLC). The radiation fields may be stored in intermediate phase-space files which 

comply with the IAEA format. Thus, simulations can be done by steps and using information 

from other simulations already performed, saving computing resources and time. The program 

has also graphical and numerical tools to analyze phase-space files. Its graphical interface 

allows users to simulate and analyze results without performing very elaborate procedures [8]. 

Thereby, a prior very detailed knowledge of the Monte Carlo method or the inner LINAC 

operation is not a prerequisite to perform simulations at Primo, which does not occur in other 

such programs. 

 

 



5 
 

1.4 Objectives of this work 
 

This project aimed to demonstrate the existence of an alternative method, based on 

Monte Carlo simulations, to calculate dose distribution profiles of IMRT treatments, since they 

require a verification process before applying the treatment to a patient. This study intends to 

demonstrate the usefulness of PRIMO in this context. Sometimes, IMRT treatments 

verification fail, i.e., the treatment plan does not correspond to the one irradiated in the 

phantom, without any apparent reason. That can happen due to physical limitations of MLC, 

which leads to LINAC incapacity to reproduces the generated plan in TPS. Another fact pointed 

out is related to the fact that the verification processing is performed using a matrix, which 

have ionization chambers separated by 1 cm. This makes the data acquisition of irradiations 

discrete in space, meaning that some results must be interpolated. This interpolation could not 

match exactly to the planned by TPS, being necessary to redo the verification process. Thus, 

this project aimed to demonstrate that PRIMO software has potential to simulate IMRT 

treatments and, perhaps, in the future, PRIMO can be used for IMRT verifications of dose 

distributions calculations, when there is no correspondence between TPS and LINAC 

irradiation. In order to achieve this major goal, it is necessary to structure the work in stages. 

First of all, PRIMO software must be validated. At this stage the main goal is to 

demonstrate that the program can simulate a Clinac 2300, one of the LINACs used in IPO 

Porto. That is made by comparing basic dosimetry curves simulated and obtained with LINAC. 

The second task is related to the validation of the MLC. Thus, a field with a given 

irradiation features and a given MLC conformation is simulated with Primo. At this stage, the 

objective is to demonstrate that simulation results are compatible with LINAC irradiation of the 

same field and with its calculation in TPS. As a result, there will be MLC validation and 

consistent evidence that the program can simulate a static irradiation field. 

Ending the project, the last step has as objective the simulation of a single dynamic 

field and also, its comparison with LINAC irradiation and TPS calculation of this same field. If 

the three modalities are compatible, the main objective of this work is fulfilled, proving the 

potential of PRIMO software to simulate a complete IMRT treatment, once it successfully 

simulates a single irradiation field.  



6 
 

2 Experimental and theoretical background 
 

2.1 Linear Accelerators 
 

Radiation therapy consists on the usage of high energy radiation for tumors 

treatment, making them smaller by the destruction of tumor cells. In this technique, X-rays, 

gamma rays and charged particles could be used. Radiation can be applied by an external 

device to the body, which is called external radiotherapy, or inserting radioactive material into 

the body, near to cancer cells, which is called brachytherapy. 

Most of the time, external radiation therapy sessions are made using a linear 

accelerator (LINAC), equipment that produces high energy x-rays.   This radiation is applied to 

the patient, in the tumor region in a way that tumor cells are destroyed and healthy tissues 

around the tumor are saved. 

The radiation production by a LINAC equipment is based on thermionic emission, 

similarly to what occurs in conventional x-rays. Thereby, an electron beam is emitted by an 

electron gun and accelerated in a tube  due to high frequency microwaves generated by a 

Magnetron or a Klystron [9]. The electrons can be used directly to treatments on body surface 

or they can hit a metal target of high atomic number and be transformed into photons to use 

in deeper treatments (Figure 2.1).  For this reason the LINACs make available two or more 

photon energies and several electron energies. 

 

Figure 2.1 – Diagram of a linear accelerator in photon mode [10]. 

 

The beam modulation and its alignment are achieved by collimators in the inside of 

the LINAC head. All the LINACs have collimators, known as traditional collimators, which are 

distinguished between primary and secondary collimators. The primary collimator is made up 

of a relatively large lead block (or simply a heavy metal alloy), in order to produce a cross 

conical beam. The secondary collimator consists in pairs of metal blocks positioned in a 

perpendicular way between them. These blocks are called jaws and they control the field size 

for each treatment. This type of collimators only restrict rectangular fields [11].  



7 
 

However, the most recent models of LINACs have an additional type of collimation 

made of several thin leaves that allows a better conformation to the tumor shape. This system 

is called Multileaf Collimator (MLC) and it allows the irradiation of irregular fields without 

personalized protections for each patient (Figure 2.2). This system of collimation in a LINAC 

brings an increase on the initial investment but, in a long term this cost is overcome. This 

happens because individual protections hard to do are not needed, the treatment time is 

diminished, which increases the profitability of the LINAC and improve the treatments. 

Nowadays, the MLC used in clinical practice have 80 till 160 leaves, each one with some 

millimeters until 1 cm of wide. Every leaf is controlled with a computer, thus conformations 

with more than 1 mm of accuracy can be achieved and consequently irregular fields can be 

formed.   

 

Figure 2.2 – Multileaf collimator [12]. 

 

In the LINAC head, ionization chambers are also present, which allow the dose 

monitoring and the end of the treatment when the prescribed dose has been delivered.  The 

gantry is the LINAC component that moves around the table where the patient is lying down. 

The table movements can be longitudinal, lateral and rotational.  In the LINAC positioning the 

isocenter has to be placed in a volume of millimeters for every movement. Multiple or 

rotational beams are applied but in all cases the tumor must be the key target. One way to 

ensure this happens is to locate the tumor on the isocenter on which everything runs around. 

In Figure 2.3  a blueprint of a LINAC is represented.  

Several diseases can be treated with a LINAC, using several techniques such as 

conventional techniques, Intensity-Modulated Radiotherapy (IMRT), Imaging Guided Radiation 

(IGRT), Stereotactic Radiosurgery (SRS) and Stereotactic Body Radiotherapy (SBRT) [13].  

 



8 
 

 

Figure 2.3  – Main components of a LINAC [11]. 

 

2.2 Dose measurement 
 

Currently the biological effects produced in irradiated tissues are associated with a 

quantity called absorbed dose. This quantity is defined as the average energy deposited per 

mass unit of a certain volume element and it is measured in gray (1Gy = 1J / kg)[14]. Absorbed 

dose is a macroscopic quantity, not stochastic and therefore not described the sequence of 

microscopic energy deposition processes. However, it is the spatial distribution of ionization 

caused by the incident radiation that determines the biological effect.  

Ionizing radiation itself cannot be measured directly. The detection is performed by 

the result produced by radiation interaction with sensitive means (detector). To be used as a 

dose meter for ionizing radiation (which is called dosimeter), a material must have certain 

properties such as: accuracy and precision in measurement, linearity, dose or dose rate 

dependence, energy dependence, directional dependence and spatial resolution [15]. 

In the measurement process of dose absorbed, several types of detectors of different 

materials and shapes can be used, in a radiotherapy context. The most common are the 



9 
 

ionization chambers, followed by dosimetric radiosensitive films, solid state detectors (as TLDs) 

and electronic devices, usually made of silicon. 

In general, an ionization chamber is constituted by a center electrode (anode) and the 

chamber wall, which is coated with a conductive material that acts as cathode. The detector 

sensitive volume is delimited by the chamber wall, forming a cavity filled with a gas or a gas 

mixture at a relatively low pressure. Between the anode and the cathode, a potential 

difference is applied to separate the ion pairs produced. As a result, negative ions migrate to 

the anode and positive ions to the cathode. This ion flow produces an extremely low electric 

current which can be measured by an electrometer, a device that measures small currents 

[15]. 

The Farmer type ionization chambers (Figure 2.4) are widely used due to its accuracy in 

reading. It is recommended for MV photon beams and for electron beam with energies above 

between 10 MeV to 45 MeV [16]. 

 

Figure 2.4 - Basic design of a cylindrical Farmer type ionization chamber [15]. 

 

2.3 Phantoms for basic dosimetry 
 

The calibration of a LINAC consists in a set of procedures in order to getting depth 

curves yield and dose profile for each irradiation field, energy, type of radiation and for each 

beam modifier accessory. To obtain this dosimetric database for a radiation treatment unit is a 

meticulous experimental work, which is called basic dosimetry [17].  

Usually, this calibration is performed in a cubic water phantom (Figure 2.5), whose 

dimensions are much greater than the irradiation fields dimensions used in clinical situations. 

The incidence of the beam is perpendicular to the water surface at a specific distance from the 

focus of the radiation. The set - up has ionization chambers to acquire the data. 



10 
 

 

Figure 2.5 – Water tank phantom for basic dosimetry[18]. 

 

2.4 Percentage Depth Dose (PDD)  
 

The Percentage Dose Depth (PDD) is a curve that shows a ratio between the 

absorbed dose in several depths and the absorbed dose in a reference depth (Zmax). In 

Equation 1 is seen the quotient that defines a PDD, in which Dd represents the dose at any 

depth and Dd0 represents the dose at a fixed reference depth (Figure 2.6) [19]. This curve is 

defined for a given material, for a specific field of irradiation, for a certain irradiation beam 

energy and Source to Surface Distance (SSD) [11]. 

 

  
  

   
                                                        Equation 1 

 

The PDD curve has an initial point which represents the dose deposited on a patient 

skin (or phantom surface). The photons interact with the matter, which increase the dose in 

the patient (or phantom) until the maximum. That area, between incident surface and the 

point where the maximum dose is achieved is called build-up region. In this area the 

interaction between photons and tissues releases electrons, which leave their energy in a 

certain distance of their origin.  

The percentage depth dose (beyond the depth of maximum dose) increases with 

beam energy. Higher-energy beams have greater penetrating power and thus deliver a higher-

percentage depth dose (Figure 2.7). In the practice, the acquisition of these profiles is made by 

using a water phantom, which is a tank made of acrylic full of water with controlled height and 

leveling.  

 



11 
 

 

 

Figure 2.6 – Geometrical PDD definition.  Q is an arbitrary point at depth Z and P is the point at Zmax. A corresponds 
to the field size [11]. 

 

 

Figure 2.7 – PDD curves in water for various photon beams at SSD of 100 cm [11]. 

 

2.5 Lateral Profiles acquisition and characterization 
 

The dose distribution (along the) the central axis is only a portion of the patient’s 

dose distribution. For two or three dimensions the distribution is achieved by the combination 

of the central axis distribution with the off-axis profiles. The dose measurement of these last 

profiles is made on perpendicular axis to the central one using some depths of acquisition. The 

most used depths dose of measurement are the depth of maximum dose , and the 5, 10 cm, 20 

and 30 cm, which are used for the planning systems. 

The profile of a megavoltage radiation beam is composed by three distinct regions: 

the central region, the umbra, and the penumbral region (Figure 2.8). The central region goes 

from the central axis to 1 cm or 1.5 cm of the geometric field border. The umbra is the region 

outside the radiation field. The penumbral region is the one that suffers the source penumbra 



12 
 

influence, the collimator radiation transmission and radiation scatter, which together make the 

physical penumbra. In this region the dose change abruptly and depends on the source size, on 

the collimation position and the lateral electronic scatter.  

The beam profile analysis is based on some parameters that define its uniformity, 

which are the flatness and symmetry. 

 

 

Figure 2.8 – Beam profiles of 10 MV at various depths in water, for field sizes of 10 cm x 10 cm and 30 cm x 30 
cm[11]. 

 

2.5.1 Flatness 

 

The flatness is a parameter calculated using the maximum and minimum dose values 

of 80% of the beam profile central part, as can be seen at Equation 2. 

 

      
         

         
                                                 Equation 2 

 

According to the LINAC components and details of its beam an excess of filtration can 

be seen on the central axis for the maximum dose depth. This fact occurs because the LINAC 

has a filter which will flat the beam. This effect will be less pronounced with the increase of the 

depth. In this situation the profile will present more rounded borders rather than peaks. The 

emission of lower energy photons outside the central axis explain this fact, when comparing to 

the ones emitted on the central axis [11].  

The traditional LINACs for clinical use usually require that the flatness would be lower 

than 3%, for measurements with a 10 cm depth and a SSD of 100 cm and for the bigger field 

available (commonly 40 x 40 cm
2
). 

 



13 
 

2.5.2 Symmetry 

 

The symmetry is a parameter measured at the maximum dose depth, since it is the 

most critical area for this evaluation, because in that point the beam profile has the peaks 

already referred. According to Task Group 142 [20], for the same profile, the beam should 

present a symmetry with a maximum disagreement of 2% between two points at the same 

distance from the central axis.  

Another way to measure beam symmetry is calculating the areas besides the central 

axis until the point of 50% dose value and compare them using Equation 3. 

 

      
            

            
                                         Equation 3 

 

2.6 Modern Radiotherapy Techniques  
 

2.6.1 3DCRT 

 

The tridimensional conformal radiotherapy (3D-CRT) is a technique that uses multiple 

beams with uniform radiation intensity to irradiate the exact treatment area, according to the 

security margins [21]. This exact targeting makes it possible to use higher levels of radiation in 

treatment, which are more effective in shrinking and killing tumors. 

 

2.6.2 IMRT 

 

Intensity Modulated Radiotherapy is an evolution of 3D-CRT, because the applied 

fields have variable intensities (Figure 2.9). It is a modality of external radiotherapy extremely 

accurate that allows the administration of high radiation doses on the target volume, reducing 

the dose in the healthy tissues around. The radiation is applied according to the tridimensional 

shape of the tumor, which is achieved by the beam modulation (Figure 2.10).  Similarly to 3D-

CRT, IMRT allows a geometrical conformation adding a dosimetric adjustment to the irradiated 

area [17]. Therefore, the toxicity of the treatment, the side effects in a short and long term will 

be reduced [22]. 

Despite the benefits of IMRT in relation to the 3D-CRT, this technique requires a 

more severe treatment plan. In both techniques the targets and structures to protect are 



14 
 

selected by the doctor, which are called the volumes of interest for the treatment. However, in 

IMRT a technique called inverse planning is introduced, while in 3D-CRT a common planning is 

used. In 3D-CRT simple beams are shaped considering field margins that will compensate the 

daily variations in configuration and the beam characteristics. In this case, the quantity and 

angle of incidence of beams and its configuration are chosen and then the dose in the volumes 

of interest is calculated. Then the plan is analyzed in terms of dose, confirming if the maximum 

dose in the organs at risk is not achieved. The plan can be remade changing some parameters 

in order to find the best treatment plan: the one with lower dose in the organs at risk and 

higher dose at the tumor. On the other hand, in the IMRT treatment planning the opposite 

process occurs. The dose in the target and in the structures to be protected is prescribed by 

the doctor.  For this purpose tolerance levels for each organ have to be determined [23]. Then, 

the program used to planning creates a series of modulation patterns in order to find the 

configuration that best match to the desired plan [21]. In general, 5 to 9 irradiation fields are 

used in an IMRT treatment, which are administered to the patient by linear accelerators with 

multi-leaf collimation systems. 

According to the way of delivering IMRT, there are two techniques that can be 

distinguished: IMRT with segmental MLC, which is known as step and shoot; and IMRT with 

Dynamic MLC. The step and shoot technique is a discrete mode of IMRT delivery, in which the 

MLC leaves move to their next position while the beam is off [24]. In this case, the sum of all 

radiation segments will produce the intensity modulated field. In contrast, with the dynamic 

MLC technique the MLC leaves are in continuous motion during all treatment. The desired 

intensity of radiation in a specific point is achieved by a variation on MLC leaves motion speed 

and the changes in their position[21].  

Even though IMRT has emerged in the beginning as an experimental technique, 

mainly in academic environment, nowadays there are a growing number of centers in Europe 

using IMRT in clinical practice [25]. Currently, IMRT is particularly indicated to the treatment of 

prostate tumors, head and neck, gynecological, gastrointestinal and central nervous system 

tumors. 

This technique requires many resources and time to its implementation. A large 

number of professionals are necessary from treatment planning, until its implementation and 

also some procedures have to be done. Thus, acceptation and commissioning tests are needed 

to implement IMRT, but also quality assurance tests of the treatments are a requisite to apply 

an IMRT treatment to a patient.  



15 
 

 

Figure 2.9 – a) 3D Conformal RT technique using uniform beams; b) IMRT technique using non uniform beams [17]. 
 

 

Figure 2.10 – Beam incidence and dose color wash on 3D-CRT (on the left) and Beam incidence and dose color wash 
on IMRT(on the right) [21]. 

 

2.6.3 Volumetric Modulated Arc Therapy - VMAT 

 

VMAT allows carrying intensity modulated treatment only in one arc. This is achieved 

through the simultaneous variation of several parameters, as MLC leaves pattern, dose rate 

and rotation speed of the gantry. This treatment technique produces high compliance 

absorbed dose distributions and is quite effective in terms of treatment time [26]. 

RapidArc ™ (Varian Medical Sistems, Palo Alto, CA, USA) is one of the solutions 

already in the market for this type of treatment [27]. RapidArc™ has recently been introduced 

in clinical practice in various institutions after an intensive validation [28]. This introduction 

requires a new work methodology, being necessary introduce a quality assurance program and 

systematic dosimetric verification. 



16 
 

2.6.4 Tomotherapy 

 

Tomotherapy is a type of image-guided IMRT that combines imaging and treatment 

capabilities in one unit [29]. The part of tomotherapy machine that delivers radiation for both 

imaging and treatment can rotate completely around the patient in the same manner as a 

normal CT scanner. This equipment can capture MV CT images of the patient’s tumor 

immediately before treatment sessions, to allow for very precise tumor targeting and sparing 

of normal tissue. The intensity modulation is obtained by a binary collimator that opens and 

closes, according to computer control. Meanwhile the fan beam runs continuously around the 

patient and bed moves at a predetermined rate[30]. 

 

2.6.5 SRS, SRT and SBRT 

 

Stereotactic Radiosurgery (SRS), Stereotactic Radiotherapy (SRT) and Stereotactic 

Body Radiotherapy (SBRT) are three techniques closely related. All of them are delivered on a 

LINAC and require extreme precision in patient positioning, because they are normally used 

when exist the need of spare immediately adjacent normal tissue[31]. 

In SRS a high radiation dose is given to a certain brain region of a patient in one or a 

few fractions. The goal of SRT is to disrupt cell division processes without completely 

destroying the local tissue. SRS, on the other hand, is an ablative technique where the goal is 

to deliver sufficient dose to the target area to kill all the cells in the target region. In this 

technique a fractionated schedule of delivery is used, although that schedule may be 

accelerated in a hypofractionated regime of as few as 3-5 treatment sessions. The difference 

between this technique and SBRT is the body region where the technique is applied. Thus the 

first one treats brain and spine tumors , the second one treats other body regions as lungs, 

liver, pancreas and kidneys, for example [32].  

 

2.6.6 Treatment monitoring 

 

In radiotherapy treatments the periodic verification of radiation fields is important, 

which is achieved through the use of images. In the most common LINACs, the image 

acquisition systems comprise a robotic arm having a panel with a matrix of detectors, called 

portal imaging system. With these detectors it is possible to obtain images, resulting from 

patient output radiation, due to the attenuation caused by tissues. These images contain 



17 
 

anatomical information of the patient and are used to verify the effects of the treatment. 

Thus, in treatment monitoring by portal images periodic information on target position and 

movement are obtained (within the same session or between consecutive sessions). Then it is 

compared with reference imaging, giving feedback to correct the patient setup and optimize 

target localization. These images also have the potential to provide feedback that may help to 

adapt subsequent treatment sessions according to tumor response [33]. 

  

2.6.7 Image guided patient positioning techniques 

 

Image Guided Radiotherapy is a technique that allows checking the patients 

positioning while they are in the treatment table. Images can be acquired through the portal 

imaging system or with the Megavoltage Cone-Beam CT technique. In the first case, the 

patient is irradiated with a very low dose in two orthogonal directions (one above and one 

side), which will create 2D images that can be compared with the corresponding image in the 

planning computed tomography (CT). In the second case, the LINAC rotates around the patient 

allowing the creation of a 3D image, which is also compared to the CT planning, which gives 

information about the patient position in relation to the isocenter.  

The imaging scans obtained are processed by computers to identify changes in a 

tumor’s size and location due to treatment. They allow the position of the patient or the 

adjustment of the planned radiation dose during treatment. The imaging repetition can 

increase the accuracy of radiation treatment and may allow reductions in the planned volume 

of tissue to be treated, thereby decreasing the total radiation dose to normal tissue [34]. 

 

2.7 Treatment Planning System (TPS) 
 

2.7.1 Treatment planning 

 

The treatment planning systems (TPS) are used on external radiation therapy to 

simulate the radiation beams and its dose distribution. Consequently, the tumor control is 

maximized and the complications with healthy tissues are minimized.  The help of complex 

calculation systems are needed to elaborate the patients’ treatment plans [35].  

To start the planning phase patients CT scans are performed, in which they are in the 

same position of the external radiation treatment. Sometimes, when the gross tumor volume 



18 
 

(GTV) location is hard to define, other types of images are required, as PET or MRI for example. 

Thus, the physician has to delineate the several volumes [36]:  

? GTV (Gross Tumor Volume) – Tumor or tumor extent detected and / or visible by 

medical palpation or identified in complementary diagnostic images (CT, MRI, PET 

/ CT). 

? CTV (Clinical Tumor Volume) – Volume of treating tissue which comprises the GTV 

associated with microscopic disease extent. 

? PTV (Planning Tumor Volume) – Defined by CTV and safety margins (about 1 cm). 

These margins compensate for changes due to the variation in size and shape of 

the CTV tissues and daily variations of the patient's face. 

? OAR (Organ at risk) – Healthy tissues/ organs close to the tumor, whose tolerance 

doses might influence the volume and / or the dose levels to irradiate. 

 

After this selection, the treatment plan is made using the TPS. The treatment plans 

for each patient have information about the position of the gantry, collimators and treatment 

table. The field dimensions, protections to use and dose are also information on the treatment 

plan. Based in all selected mechanical properties and dose values assigned to each treatment 

plan are found the Monitor Units (MU) that should be applied in each irradiation field of 

treatment. In the final phase of the planning process dose volume histograms are created, 

which are evaluated by doctors for approval of treatment plan. 

There are several planning systems available in the market, but in the context of this 

project the Eclipse system is the most important to refer, because is the one used in IPO Porto. 

With this system the radiotherapy treatment plan is a faster and easily process. In the 

particular case of IMRT treatments, Eclipse combines tools from 3D-CRT with a fast, accurate 

and interactive dose optimization. Furthermore this system also allows automatic optimization 

of beam geometry, simplifying the  task of select the best incidence angles of beam radiation 

in IMRT [37]. 

 

2.7.2 Dose calculation algorithms  

 

One of the most used dose calculation algorithm is the pencil beam. This technique 

assumes that any collimated photon beam incident on the patient is a group of lots of smaller, 

narrow pencil beams. Each of these pencil beams has a central axis ray along which it deposits 



19 
 

some dose. The dose deposition pattern varies with the intensity and the spectrum of the 

beam that is incident on the patient [38]. 

The Anisotropic Analytical Algorithm (AAA) is a considered a 3D Pencil Beam 

superposition-convolution model [26] and it was the first algorithm of this kind being 

implemented on Eclipse Treatment Planning System from Varian Medical Systems. 

The superposition-convolution algorithms are explained by a model in which the 

dose deposition is seen as weighted responses (kernels) superposition for specific radiations. 

Kernels represent the transport and dose deposition energy of secondary particles coming 

from the irradiation point. When kernels are spatially invariant, this superposition can be 

evaluated using convolutions [26].  

AAA applies kernels derived from Monte Carlo calculations, which are sized to be 

adjusted to local density. This algorithm considers tissues heterogeneity anisotropically by 

dispersing kernels in multiple lateral directions. The final dose distribution is obtained by 

superposition of the doses from the photon and electron convolutions[39]. Comparing AAA 

with other algorithms as Pencil Beam Convolution (PBC), it presents a better performance, 

because AAA is able to model with higher precision the electrons transport in a heterogeneous 

medium [40]. The computation time to calculate this algorithm is reduced, and similar to PBC, 

when calculated in Eclipse. 

 

2.7.3 Isodose distributions  

 

A dose distribution in a three-dimensional volume cannot be characterized only by 

depth dose distribution in the central axis. To represent a planar or volumetric variation in 

absorbed dose, the distributions are represented by lines passing through points with the 

same dose values, which are called isodose curves [19]. 

The planning systems calculate for each field configuration the dose distribution, 

given by a set of isodose curves, which are quantitatively evaluated from dose volume 

histogram (DVH). The DVHs are statistic dose tools that allow knowing the dose reaching a 

certain volume of a given anatomical structure [17]. With the help of DVHs, a planning 

evaluation is made, based on dose distribution analysis around the PTV and OARs. For this 

reason, in each image slice, the isodose distributions must be inspected [41]. 

 

 



20 
 

2.7.4 Dose distribution verification techniques 

 

Before the first treatment session, the MUs generated in planning system should be 

checked using an independent verification system. In the case of IMRT treatments, the 

correlation between MUs and dose delivered to each intensity modulated field is not much 

evident, and problems that can occur cannot be predicted by these means [42]. Therefore, for 

purposes of dose administered quality control, the achievement of absolute dose and relative 

dose verification tests are requirements for IMRT planning. 

The purpose of absolute dosimetry is measure the deviation between the dose 

planned and dose in a point, typically the isocenter, while relative dosimetry has as goal to 

determine the accuracy of dose distribution. The relative dose verification consists on the 

comparison between the irradiation of a field planed for the patient on a cubic phantom 

(always with the angle of the gantry at 0 °) and the planar image provided by the Electronic 

Portal Imaging Device (EPID) (or other verification system) after its irradiation according to the 

respective patient's treatment parameters. The dose distribution plan adapted to a geometric 

phantom should also be compared with the resulting dose distribution in irradiated films (or in 

other detector) after patient’s treatment simulation. To be considered absolute dose 

verification, the absorbed dose in films should be normalized to the isocenter dose value, 

obtained with the plan irradiation using a calibrated ionization chamber[43]. 

These tests are protocolled in order to ensure the reliability in the execution of each 

patient planning. These protocols include pre-treatment verifications and periodically 

verifications over the treatment. 

 

2.8 Phantoms for IMRT verification 
 

A phantom is an object that can represent a patient in terms of absorption and 

scattering properties of radiation. A phantom can be geometric or anthropomorphic and can 

be filled with water, homogeneous solid material or materials equivalent to human tissue. All 

of them allow the access to relevant dosimetry information, by the introduction of some kind 

of detector therein. This makes phantoms an essential tool in the evaluation of equipment 

operating conditions or in quality control checks.  

In daily IMRT treatments verification, a geometric phantom made by solid water 

slabs is widely used (Figure 2.11), which simulates the radiation absorption and diffusion 

properties in human tissues. The solid water slabs reproduce the dosimetric properties of the 



21 
 

tissues, in a simple way, reducing anatomy complexity and presenting regular geometries. 

These slabs are made of water-equivalent plastic and have holes for different types of 

ionization chambers, in particular for Farmer type, allowing that absolute or relative dose 

measurements be achieved [44]. 

 

Figure 2.11 – Solid water phantom used in IMRT treatments quality control [45]. 

 

2.9 Monte Carlo dose distribution calculations 
 

Stochastic methods are known since before the advent of computers, however only 

in 1947 the name of Monte Carlo Methods has been assigned [46]. This term encompasses a 

class of numerical methods based on random numbers usage. These methods are very used in 

areas as physics and mathematics, in particular at large number of independent variables 

problems [47]. 

In Monte Carlo simulations of radiation transport, a particle is seen as a random 

sequence of free paths, which ends with an interaction. Therefore, the particle could change 

its direction of movement, loses energy, and occasionally produce secondary particles. This 

simulation is the numerical generation of random events and a model to describe them is 

needed. Thus, a set of differential cross sections (DCS) are created for the relevant interaction 

mechanisms. The DCSs determine the probability distribution function (PDF) of the random 

variables that characterize an event, such as interaction between successive events of a free 

path particle, the type of interaction occurred, and the loss of energy and angular deflection 

due to an interaction [48]. As these PDF are known, it is possible to generate random events by 

using appropriate sampling methods. 

Monte Carlo algorithm includes some components that should be highlighted: the 

probability distribution, since the system has to be described by one or more PDFs; the 



22 
 

random number generator from where the entire process begins, which must be fast and 

reliable. 

The Monte Carlo calculations can take a long time, especially in radiotherapy 

applications. For this reason, techniques to increase simulations speed are needed, which are 

called variance reduction techniques [46]. Particle splitting, Russian roulette and forced 

interaction are three techniques that worth to be highlighting in this context. 

In particle splitting, the particle to being controlled is divided into several particles, 

which are followed individually. Mathematical aspects of particle splitting are the other 

variance reduction techniques basis. 

Russian roulette is a mathematical tool essential to the other variance reduction 

techniques implementation. This technique combines several particles at once, but only a 

single particle at a time is followed. Accordingly to this, the probability of 1-p (typically 90-

99%) is assigned for the death of a particle, but its weight is increased by a factor of 1/p when 

the particle survives. The necessity of this tool is evident when used with the forced 

interaction (discussed below), since without the particle "death" in russian roulette, the first 

interaction would never end. This is a method performed when the particle weight is below a 

certain "cut" value. In Russian roulette the variance of the problem is increased, but Monte 

Carlo calculation efficiency is also increased. Therefore computer time is saved, which would 

be spent on low-weight particles. 

Forced interaction technique forces a collision on a given segment of the particle 

path, which is located inside the region under study. This should make particles live longer and 

have more chance of being counted. 

Several Monte Carlo codes are available for simulation of many types of particles 

transport and in a wide range of energies. The most general Monte Carlo codes, as GEANT, 

MCNPX or FLUKA, simulate the transport of various types of particles (electrons, positrons, 

photons, protons, neutrons, heavy ions, etc.) to a wide range of energy[49]. Those programs 

have various applications such as detectors simulation response; medical treatments 

simulations; radiological protection dosimetry; study of the radiation effects in 

microelectronics, etc. More specific codes, such as PENELOPE, EGS, ETRAN, ITS, they focus on 

electrons and photons transport [50].  

Monte Carlo methods are considered the most accurate methods for dose 

calculation in radiotherapy [51]. They can model realistic radiation transport through the 

LINAC head, the MLC and the patient anatomy accurately.  In this context, several programs 

directly indicated to radiotherapy have been developed such as: VMC/XV MC, DPM, MCV and 

MCDOSE [50]. These codes use multiple variance reduction techniques and complete 



23 
 

calculations with a reduce CPU time, in comparison with ordinary EGSnrc calculations [52]. 

Most recently, another simulation program of radiotherapy treatments came up, known as 

PRIMO, which will be studied next. 

 

2.10 PRIMO (Penelope based MC code) 
 

PRIMO is a Monte Carlo program to simulate a wide range of Varian and Elekta linear 

accelerators [53], as well as their electron applicators and multi-leaf collimators. This program 

allows the calculation of the dose distribution in the patient in a simple way, without being 

required deep computing knowledge. This is possible because PRIMO is made of a combination 

of several programs [54], which work together in order to make PRIMO a potential tool in 

radiotherapy treatments simulations. Also for this reason, PRIMO is interactive, intuitive and 

simple to use, in contrast to other Monte Carlo simulation programs. 

The PRIMO codebase for physical aspects is PENELOPE. It allows the simulation of 

radiation transport in a LINAC, as well as the absorbed dose distributions in a phantom or 

patient. The remaining constituents of PRIMO programs and their respective functions are 

shown in Figure 2.12. 

 

  

Figure 2.12 – Scheme that has all the components of PRIMO [55]. 

 

To begin the project, a device model to simulate as well as the operation mode 

(electrons or photons) must be chosen. Then, the calculations performed by this program can 

start selecting other parameters of interest, which are divided into three phases. In the first 

one (s1) are determined the energy of irradiation (nominal energy), the initial energy, the 

energy of FWHM, the focal spot of FWHM and the beam divergence. In this step is created a 



24 
 

phase-space file that contains information about the particles created and its interaction on 

the LINAC head. In the second stage (s2) the interaction in the bottom of the LINAC of all 

particles generated in S1 is simulated. The interaction occurs between particles and the jaws, 

MLC and air space until the phantom (or patient). In s2 are determined the presence or 

absence of MLC, the number of fields, its size and configuration. In the third and final stage 

(s3) the interaction between particles coming from previous segments with the phantom (or 

patient) is simulated. Here is chosen the use of a phantom (and its definitions) or a patient CT 

image and the SSD. These three segments can be launched one at a time or all together, but 

before parameters relating to the variance reduction techniques, simulation time, number of 

particles, number of cores used and with random numbers must be chosen. 

Once all simulation steps are finished, the dose profiles in the phantom (or patient) 

are obtained. The generated files can be analyzed using tools provided by PRIMO. To s1 and s2 

the generated phase space files can be accessed and analyze. In s3, the dose distribution 

profiles can be seen, studied and compared with other calculated or experimental curves. This 

comparison tool is based on the gamma test that will be explained next [55]. 

 

2.11 Use of Gamma Index function for MC simulations validation 
 

A simple way to evaluate the obtained results is overlapping two dose distributions: 

for example, compare a distribution from the TPS with a measured in the LINAC. With this 

analysis it can be seen that the areas are not totally coincident in both images, compatible 

regions and less compatible regions can be distinguished. However, obtain more accurate 

results, meaning quantitative data, can be a hard task to do. 

The first criterion used to perform a quantitative evaluation was the dose difference, 

which is good for regions with low gradient dose. However, for areas with a high gradient dose 

this criterion is not suitable, since small space deviation brings a big dose difference. For this 

reason, another criterion, called DTA (Distance-To-Agreement), has been admitted in order to 

evaluate the high dose gradient regions. 

The analysis of dose distributions (fluence) is performed comparing the dose and 

DTA, which determines if the dose distribution measured with LINAC is in accordance with the 

one that was planned. In this context, a function called Gamma Analysis or Gamma index has 

appeared. 

The dose analysis [56] is a method that combines the dose difference and DTA 

criterions for comparing two dose distributions (e.g., a simulated curve and a curve obtained 



25 
 

experimentally). The dose difference is evaluated by exploring the dose distribution in the 

neighborhood of the experimental points. For a given experimental point P, where the dose in 

the point is de(p), the gamma index, ?, is given by: 

 

?          
   

  
 
 
  

   

  
 
 
  ,                                      Equation 4 

 

where are arbitrary constants known as the acceptance criteria for dose difference and DTA 

(values used are typically 2% and 2 mm for ?D and??S, respectively). The term ?di is the 

difference between de(p) and the simulated dose at a certain point pi; and ?si is the distance 

between p and pi. Evaluating the set of points pi and finding the minimum value of the 

expression in brackets the gamma index value is discovered [57]. Through this analysis it is 

possible to obtain information about the zones where the dose distribution is in according, or 

not, to the acceptability criteria [58]. 

  



26 
 

3 Methodology 
 

3.1 Basic Dosimetry 
 

The validation of the program in study requires the comparison of basic dosimetry 

curves generated by PRIMO with the ones acquired in the LINACs every six months. When both 

curves match according to the gamma index test, PRIMO is validated and other studies can be 

started. 

To acquire the PDD, in a LINAC, a setup with a water phantom has to be mounted. 

First of all, the gantry and collimator must be in 0º and the table on 90º. Then the tank can be 

centered under the gantry and filled with water. After that the controller and the electrometer 

should be connected to the tank cables and all the equipments can be turned on. The next 

step is level the tank, align it with the lasers, put the thermometer in the water to stabilize, 

and adjust the SSD to 100 cm. At that moment, the measuring and reference ionization 

chambers (PTW Semiflex Ionization Chamber 31010) can be connected to the electrometer. 

The measuring chamber is dipped until the limit of water surface and the reference chamber 

stay in the support above the water tank in the limits of the irradiation field. Finally the 

pressure and temperature values are noted and the practical acquisition of PDD and lateral 

profiles is started.  

With the purpose of finding the best curve to use on the validation process, the 

variation of the PDD curve over time (to the same LINAC) will be studied. To reach that goal 

the maximum of the curves will be calculated and compared with the ones obtained in the 

acquisition program, called MEPHYSTO.  

 

3.1.1 Basic Dosimetry Curve Analysis 

 

To analyze the PDD curves the first thing to do is to calculate the curve that better 

fits the maximum of the PDD. This is done in order to discover the accurate value of depth to 

the maximum dose, once in practical acquisition the curve obtained is made of discrete points. 

The maximum value is found by an interpolation of the points made by Mephysto. This process 

of interpolation is not known, that is why it is so important to calculate the PDD maximum 

using a known procedure. 

The first step in this procedure is to select the maximum values of each curve 

(approximately the twelve maximum values) and choose the degree and parameters of the 



27 
 

function. The adjustment of these parameters is made by using the solver tool from excel. The 

function selected was the one in which the sum of the residue difference (between values 

from Mephysto and the ones calculated by the new function) was minimal. With this step the 

function is founded for each PDD curve. Calculating the first derivative of the function the 

maximum values of the curve were found. Those values were compared with the ones 

obtained with Mephysto and both were analyzed regarding the parameters: quality index (Qi 

or QI), the depth of the maximum dose (R100) or 80% and 50% of dose (R50, R80) and 

percentage dose at a depth of 100 mm (D100). The quality index parameters are calculated 

based on help documents from Mephysto using Equation 5 and Equation 6, where D200 is the 

dose at depth of 200 mm [59]. The same kind of analysis was made to the lateral profiles x and 

y. In this case the profiles flatness and symmetry along the years were calculated and 

compared with the ones given by Mephysto. This calculation was made using the equations 

already showed in Flatness and Symmetry on the Theoretical Background, also present in 

Mephysto help documents [60]. Ending this procedure the curves for comparison and 

validation of PRIMO can be chosen, which are considered in this context reference curves. 

 

 
 
 

    

    
                                                                           Equation 5 

 
 
         

 
                                                                              Equation 6 

 

3.2 PRIMO Simulation 
 

To start a PRIMO simulation the first thing to do is write the simulation name on 

Project ID space that can be seen in Figure 3.1. In the same window is chosen the folder where 

the project is saved, and most important, the LINAC to simulate and the operation mode are 

selected. In this work, a Clinac 2300 with operation mode in photons will be always used. The 

simulations were performed in an Intel(R) Xeon(R) CPU E5-2660 v3 @ 2.60GHz 2.60GHz with 

16GB of RAM, with 32 CPU cores working at the same time. 

After that, the simulation segment 1 can be set up as shown in Figure 3.2. In this stage, 

parameters as nominal energy, initial energy, energy FWHM, focal spot FWHM and beam 

divergence are defined. The nominal energy used was 6 MV for all the simulations performed. 

The other parameters were changed until the best simulation results were achieved. After 

validate PRIMO these parameters did not suffered changes. In Figure 3.2 are the parameters 

that get the best accordance with practical results. To simulate this segment a check signal 

must be put in the check box of S1. Other parameters related to S1 should be configured 



28 
 

before launch the simulation. The variance reduction techniques configuration will not change 

for all simulations (Figure 3.3). At S1 is chosen the splitting roulette for the splitting above 

jaws, since all simulations have initial energy lower than 15 MV. For size of splitting region the 

second option will be selected (fitted to the field size), because in this work only fields with 

10x10 cm
2
 will be simulated. In simulation configuration, the simulation time or the number of 

histories is defined as stopping criteria, as can be seen in Figure 3.4. These parameters affect 

statistics, that’s why after finding the best parameters for S1, a new simulation with a higher 

number of histories should be done. In this window is also configurable the refresh time for 

simulation partial report and the number of processors used in calculations. The random seeds 

should also be switched before any simulation beginning, in order to obtain more reliable 

results, which change randomly clicking on dices. Then the save button should be pressed and 

the simulation of S1 launch.  

 

 

Figure 3.1 – PRIMO window that opens when new Project is selected. 

 

 

Figure 3.2 – Parameters of Segment 1. 



29 
 

 

Figure 3.3 – Variance reduction configuration for s1. 

 

 

Figure 3.4 – Simulation configuration. 

 

In segment 2 is defined the data related to the jaws, MLC and gantry. To simulate this 

step, similarly to what occurred in S1 it is necessary to check the S2 box, as shown in Figure 

3.5. In this work, only the boxes related to MLC and jaws will suffer changes, the remaining 

ones will not. For all PRIMO simulations in the context of this project, the field size will be 10 x 

10 cm
2
 (Figure 3.6). After validate PRIMO, MLC should be introduced. In the MLC box it is 

selected the same MLC present in the simulated LINAC. In this particular case, once it is 



30 
 

intended to simulate the 6MV beam of a DHX HP LINAC from Porto IPO, the millennium 120 

MLC will be choose. After all parameters be defined, the simulation configuration window 

should be opened and select the stopping criteria number of histories that came from S1. 

Then, all configurations are saved and S2 simulation is launched.  

Segment 3 is the simulation part related to the dose distribution on the phantom or 

patient, thereby is at this stage that information about the receptors of radiation are defined. 

In Figure 3.7 a layout of the configuration window of s3 can be seen. There are the options to 

simulate a dose distribution on a water phantom, on a slab phantom or in a CT. In this work 

only simulations with a water phantom and with a CT were performed. To validate PRIMO the 

simulations were made using the water phantom. For this reason, it was necessary to define 

the grid of calculation: the total size and the bin size. Otherwise, in simulations after PRIMO 

validation a CT scan of a phantom used in practical measurements was used. In this case there 

is no need to complete anything, because CT scan already brings all the information about the 

calculation grid. Defining all this, and the box of S3 with a check signal it is time to configure 

the variance reduction parameters for S3 (Figure 3.8). In this window is checked the splitting in 

a phantom or CT with a splitting factor of 200. This value was used by recommendation of 

PRIMO project authors. After that, the simulation configuration window is opened and once 

again is selected the stopping criteria on the number of histories. Then, this entire 

configuration is saved and S3 is launched, finishing all the simulation steps. 

 

 

Figure 3.5 - Parameters of Segment 2. 

 



31 
 

 

Figure 3.6 – Configuration of the irradiation field. 

 

 

Figure 3.7 - Parameters of Segment 3. 



32 
 

 

Figure 3.8 - Variance reduction configuration for s3. 

 

3.3 PRIMO validation 
 

To validate PRIMO software, the basic dosimetry curves simulated must be 

compatible to the ones selected before, from the biannual LINAC tests. With this correlation 

PRIMO is validated, the parameters of s1 are found and there is no need to redo simulations of 

the LINAC head.  

The discovery of the parameters is done by trial and error, trying one by one all the 

parameters that can be adapted by PRIMO and comparing the simulation with the reference 

curves. First of all, the variation of the simulation results according to the number of histories 

will be studied. In order to do that, it will be checked if the simulation time is proportional to 

the number of histories. Simulations with an increase on time will be done and the number of 

particles checked. Then, the statistical uncertainty will be also studied. In that case, it will be 

chosen the minimal simulation time to obtain results with acceptable statistical uncertainties, 

which is a parameter connected to the number of particles.  

The energy of the electrons in the electron gun is another parameter that has to be 

studied. The nominal energy was for all simulations 6MV, but for the initial energy simulations 

with energies between 5.4 MeV and 6.26 MeV were made. The best value of initial energy is 

the one that the PDD curves simulated and obtained are most coincident. The beam 

divergence, energy FWHM and focal spot FWHM also suffer changes in their values. Although 

these parameters are related to S1, the three segments have to be simulated in order to check 

the results. This happens because only the last simulation segment gives curves that can be 

compared with the ones from the LINAC. 

As nominal energy was constant for all simulations the variance reduction techniques 

does not suffer many alterations. The variance reduction technique splitting roulette is more 



33 
 

efficient to low energies simulations (above 15 MeV) when compared to rotational splitting 

[57]. Thus, as the only energy used in simulations was 6 MeV the variance reduction technique 

used was always splitting roulette with the parameters suggested in the PRIMO’s user manual 

for the example of a Varian Clinac 2100 simulation [57]. 

To validate PRIMO software the coincidence of the lateral profiles simulated and 

acquired in practice must exist. This step is not as easy as the coincidence between PDD 

curves. In PDD curves the parameter that most affects the result is the energy of the beam, but 

in lateral profiles this question is not so obvious. Lateral profiles will be affected by factors that 

are not directly connected to the first simulation segment (S1). Parameters controlled in S2 

and S3, as field dimensions and visualization grid of dose distributions, respectively, have a 

major importance in this question. Therefore, the field dimension must be confirmed, which 

was 10 cm x 10 cm for all simulations made in this work. If penumbra regions where coincident 

the fields have the same size. The size is confirmed by the position of the penumbra region in 

the position axis. However, dose distribution simulation grid controlled in S3, in the voxels 

dimensions, can affect this result. Consequently, some grids should be tried in order to obtain 

the best coincidence between lateral profiles. All of these simulations were made using a 

water phantom in S3, which the voxels size and number of primary histories will be optimized 

to obtain statistical uncertainties below 2% in suitable calculation time. 

When this process is finished, PRIMO software is validated and more complex 

simulations can be done.  

 

3.4 PRIMO output problem 
 

The PRIMO output is shown in the program as images and graphs. However, the data is 

not easily accessible using other programs. The only file that is exportable to other programs is 

a text file with all the values generated by PRIMO. As this document is not easy to understand, 

interpret the file and convert it into an image is imperative. This transformation is important to 

compare PRIMO output with data from other programs or practical data, which is a big goal in 

this project. 

In addition to the fact that the output document can be of complex interpretation, 

comparing to other programs than PRIMO, it can present two layouts according to the 

simulation type. If the simulation is with a water tank phantom the data organization is 

different than if the simulation were with a slab phantom CT (the one used in practical 



34 
 

measurements). This situation complicates the output data conversion to other programs, 

such as Verisoft from PTW Freiburg.  

To solve this problem a set of Matlab functions was created (Appendix A). They have as 

final objective to manipulate the PRIMO output in order to create dose images at specific 

locations in DICOM format, independently of the data output type. For a simple field, i.e. only 

one field no matter its configuration, this task is not much difficult. The output data is read by 

a Matlab function and converted into a matrix for a given depth (or for a given value of x or z, 

accordingly to the final goal). Then, this matrix is transformed into a dicom image which can be 

introduced in Verisoft to be compared with another image from TPS or from LINAC.  

However, if the simulation contains more than one field, this process of conversion 

needs more steps. Thereby, before convert PRIMO data into a matrix, a merge of all fields 

must be done, for a given depth. In order to achieve that, a weighted mean of all fields is 

made. This transforms the data from several fields in data with similar structure of the initially 

obtained from one field. After that, the procedure is the same used to one field: convert data 

into a matrix and transform it in a dicom image.  

 

3.5 Quality Assurance (QA) Test 
 

A verification of the dose distribution to be administered to the patient in an IMRT 

treatment needs to be performed by physicist for every treatment plan. This procedure is 

made using quality control software, such as PTW-Verisoft. Thereby, after being completed the 

treatment plan the physicists will verify if the plan (adapted to a water phantom) is coincident 

with the measurements on the phantom. This comparison is made based on the gamma index 

test. When the distribution dose profiles simulated and measured have a compatibility higher 

than 95%, with a gamma index to 3% and 3mm, the treatment is approved and administered 

to the patient. Otherwise is necessary to find what was wrong and redo the QA. In this part of 

the work, the same thing will be done, with the addition of PRIMO output comparison. 

After performed simulations in PRIMO, the same irradiation set-up will be calculated 

in TPS in order to be scheduled and sent to the equipment to be applied. Then, practical 

measurements on the LINAC will be acquired using the same set-up of QA tests for IMRT 

treatments. A phantom of 30 cm x 30 cm x 15 cm is placed on the top of the bed. The phantom 

is made of a material with similar physical properties to the water, in this case the slabs are the 

PTW RW3, which have an epoxy resin coverage. There are 4 slabs of 1 cm and 1 slab of 0.2 cm 

above the detectors (Figure 3.9) and 10 slabs beside them. Between the slabs is placed a PTW 



35 
 

Octavius
? 

I (RW3729 array) (Figure 3.10). This is a 27 x 27 cm
2
 matrix with 729 ionization 

chambers that will obtain de dose distributions.  

 

 

Figure 3.9 – Solid water phantom used in IMRT treatments quality control in Porto IPO being mounted on the LINAC 
table for a verification procedure. 

 

 

Figure 3.10 – PTW matrix of 27 x 27 cm
2
 formed by 729 ionization chambers, spaced by 1 cm, which is used in the 

solid water phantom at IMRT treatments quality control [45]. 

 

 

 



36 
 

3.6 MLC Tests 
 

Once PRIMO is validated the MLC is added. This is crucial to the aim of this project, 

since there is no IMRT without MLC. Thus, MLC tests will be made in order to prove that 

PRIMO has potential to simulate IMRT treatments. 

At this stage some tests with MLC will be done, but all of them will have the same 

logistics. A PTW Octavius
? 

I (RW3+729 array) was imaged by a GE LightSpeed CT scan, 

introduced in PRIMO and used as the voxelized phantom. Then, PRIMO simulation is launched 

using the same parameters that validated PRIMO software. The obtained data is converted in 

dicom images, using the procedure already exposed in PRIMO output problem. In second place 

the same test is made in TPS and irradiated in a LINAC, using the set-up of IMRT QA tests, 

which were already described. At last, the three results are compared using Verisoft, to see if 

they are compatible according to gamma test. This procedure is made for every MLC test, 

before proceed to the next one. 

The first test made was to see the influence of MLC addition in simulations with an 

open field. The same MLC present in the LINAC was selected in PRIMO without any 

configuration, i.e., maintaining an open field of 10 x 10 cm
2
. In the institute, the LINACs 2300 

have an MLC of type Millenium 120 MLC, which was used in simulation. After that, the same 

configuration was used in TPS calculation and was irradiated in a LINAC. 

Keeping the same MLC, the second test consists in adding a configuration to it. This 

represents an irradiation of a static field. The configuration was chosen in order to test both 

sides of MLC leaves. Therefore, some leaves staid opened and others closed, as represented in 

Figure 3.11. 

After validation of static MLC, the most important step for this project can be done: a 

test with dynamic MLC. This will be the concept proof that PRIMO can potentially be used to 

verify IMRT treatments. At this stage, a dynamic IMRT plan was calculated by the Eclipse™ TPS 

and irradiated. Based on this plan, a dynamic MLC delivery was split into 89 static segments 

and simulated on solid water phantom as reported in Figure 3.12 and Figure 3.13. The dynamic 

IMRT plan was delivered on a solid water phantom, in the same condition of the routinely 

Quality Assurance (QA) measurements: solid water phantom centered and positioned at SSD 

95 cm with the 729 array placed at 5 cm of depth in the phantom.  This represents the 

irradiation of one IMRT field in a LINAC, when is used the step and shoot technique. 



37 
 

Given the matrix design, which has 1 cm spaces between ionization chambers, it was 

used also gafchromic for the last test. This would assure the compatibility or not between the 

three images, since its spatial resolution is better than the one associated to the matrix. 

 

 

Figure 3.11 – MLC static configuration. 

 

Figure 3.12 – Example of Dynamic IMRT divided into 89 static MLC shaped fields. 



38 
 

 

Figure 3.13 – Simulation Setup. The red mark indicates the isocenter placed at the center of the ion chamber array. 
The isocenter is at 100 cm distance from the beam source. The numerical voxelized phantom is created by the 
internal conversion tool of PRIMO, once the CT scan calibration curve is introduced. 

  



39 
 

4 Results and Discussion 
 

4.1 Basic Dosimetry Curves Analysis 
 

Every six months, LINAC tests using water tank are performed to verify PDD curve, 

lateral profiles and other parameters. The curves obtained in these tests are the ones used in 

PRIMO comparisons, for validation purposes. However, over the years many curves were 

obtained from these verifications. Thus, a study about them had to be made in other to choose 

the best curves to use in PRIMO validation. Thinking in PDD curves, it is obvious that from 

those measurements is not possible distinguish the maximum value, since the curve is made by 

discrete points. Thus, the maximum value of these PDD curves has to be calculated according 

to the methodology already presented in the previous chapter.  From calculations of the curve 

that best fits the maximum PDD curve points it was obtained, for every curve analyzed, a three 

degree polynomial equation. Calculating the first derivative, the zeros are obtained and 

consequently the depth of the maximum dose for that set of points, which is one of the zeros. 

In Figure 4.1 the points calculated and given by Mephysto are shown and the differences are 

visible. R100 from Mephysto and R100 adjusted oscillate around a midline and they are limited 

by a margin of 2?, which means twice the standard deviation (k = 2; Prob(2?) = 95.4%). The 

values suffer variations that seem to be random over time, not being possible to distinguish 

any trend.  

All values are in the considered range, but some of them are near the borders. The 

first values of R100 and R100 adjusted are the most compatible and they are in the middle 

line. All the other values suffer variations in relation to each other. Although in the end they 

tend to the first value, the one from commissioning, because LINACs are adjusted when out of 

the limits in accordance to those values. 

 



40 
 

 

Figure 4.1 - Maximum dose depth. 

 

Regarding to the lateral profiles x and y a variation in the values of flatness and 

symmetry also occurs. This variation occurs between the calculated and Mephysto values as 

well as between the symmetry and flatness values over time. This fact can be observed in 

Figure 4.2 and Figure 4.3 for lateral profile X; in Figure 4.4 and Figure 4.5 the variations in 

lateral profile Y. The differences among calculated and Mephysto values are explained for the 

expressions used to calculate the data, since the expressions used in the program are 

unknown. However, the variations over time in flatness and symmetry calculated and from 

Mephysto are the same. Similarly to what occurs with PDDs the changes over time are random 

around a central middle line. Although, the values increase and decrease over the years always 

tending for the values from commissioning.   

After this analysis of the PDD curves and lateral profiles over the years, the data 

chosen for simulations comparison were the ones from commissioning. They were selected 

because the reference for adjustments that LINAC suffers over time and data analyzed proves 

this fact. 

 

0 

2 

4 

6 

8 

10 

12 

14 

16 

18 

20 

0 5 10 15 

Depth of the Maximum Dose 

R100 (Mephysto) 

R100 Adjusted 

Mean value 

Minimum value 

Maximum value 



41 
 

 

Figure 4.2 – Flatness over the years for lateral profile X. 

 

 

Figure 4.3 – Symmetry over the years for lateral profile X. 

0 

0,5 

1 

1,5 

2 

2,5 

3 

0 2 4 6 8 

F
la

tn
e

ss
 %

 

Moments of measurments over time 

Flatness over time 

Flatness 

Flatness (mephysto) 

0 

0,1 

0,2 

0,3 

0,4 

0,5 

0,6 

0,7 

0,8 

0,9 

1 

0 2 4 6 8 

S
y

m
m

e
tr

y
 %

 

Moments of measurments over time 

Symmetry over time 

Symmetry 

Symmetry (mephysto) 



42 
 

 

 

Figure 4.4 - Flatness over the years for lateral profile Y. 

 

 

Figure 4.5 - Symmetry over the years for lateral profile Y. 

 

 

0 

0,5 

1 

1,5 

2 

2,5 

3 

0 2 4 6 8 

F
la

tn
e

ss
 %

 

Moments of measurments over time 

Flatness over time 

Flatness 

Flatness (mephysto) 

0 

0,1 

0,2 

0,3 

0,4 

0,5 

0,6 

0,7 

0,8 

0,9 

1 

0 2 4 6 8 

S
y

m
m

e
tr

y
 %

 

Moments of measurments over time 

Symmetry over time 

Symmetry 

Symmetry (mephysto) 



43 
 

4.2 PRIMO validation 
 

The validation of PRIMO requires the study of many parameters, in order to 

understand how they change the basic dosimetry curves simulated by the program. The first 

parameter to be studied was the number of histories. First of all, the relationship between the 

number of histories and simulation time should be optimized. After running several 

simulations with different time lengths, a graph with the relationship between the number of 

histories and the simulation time was built. In this graph, shown in Figure 4.6, an increase of 

the histories number can be seen when the simulation time also increases. However, some 

points differ of this linear correlation. This happens because the processor activity influences 

these parameters, meaning that if the computer is running other task while simulation is 

running, the number of histories will not be the same as if the processor was only doing the 

simulation, considering an equal duration. Sometimes, this question is hard to overcome 

because the computer software (Windows 7) has some hidden processes running during 

Monte Carlo simulations that come from other tasks, which reduces the computer processing 

capacity. For this reason, if a previous number of histories have to be achieved, it is not 

convenient simulation time to be used as stopping criteria. For this purpose it is better to 

select the number of histories instead.  This technique was adopted, but the amount of time 

wasted to a given simulation was too big and the results did not show a big difference. In fact, 

they were similar to the ones obtained in simulations based on time. For example, to get a 

simulation with about 1x10
8
 histories, it would take about a month, which is not reasonable for 

a project with this dimension. However, for a simulation with a week of duration the obtained 

results were very satisfactory. In this analysis it was perceptible that simulations with a major 

number of histories had better statistic, i.e., the curves generated were smoother (Figure 4.7). 

It happens that the higher the number of histories, the better the statistics, but only up to a 

point in which the improvement was not noticeable. However, there is no number of histories 

that give an ideal simulation curve, with the less oscillation as possible. Thus, a balance 

between time consumed and simulation results in statistic terms must be made. Because of 

this, the stopping criteria time was chosen as work method in this task, since it obtained an 

acceptable number of histories and consequently a good simulation statistics in a time interval 

controlled by us. This will bring similar results with a smaller waste of time. To minimize the 

influence of the hidden processes referred before, and get a number of histories proportional 

to the simulation time, the computer should be restarted before launch any simulation. The 

proportionality between the number of histories and the correlation of calculated and 



44 
 

measured data (based on gamma index) is also studied, as shown in Figure 4.8. As can be seen, 

there is no relation between both variables. The increment of the number of histories 

generates more points, more statistics, smoother curves, but not necessarily accurate profiles. 

The precision of the profiles is affected by other factors, which will be studied forward.  

 

 

Figure 4.6 – Number of histories in function of the simulation time. 

0,00E+00 

5,00E+06 

1,00E+07 

1,50E+07 

2,00E+07 

2,50E+07 

0 500000 1000000 1500000 

H
is

to
ri

e
s 

Time (s) 

Histories vs Time 

Histories vs Time 



45 
 

 

Figure 4.7 – PDDs from simulations with the same conditions but with different time as stop criteria. A – PDD from 
simulation with 1.97 x 10

6
 histories. B – PDD from simulation with 9.37 x 10

6
 histories. 

 



46 
 

 

Figure 4.8 – Percentage of passing points in function of the number of histories. 

 

The next parameter to study was the energy of the electrons when they leave the 

electron gun. This is a parameter analyzed through comparison of PDDs calculated and 

measured on Varian Clinac 2300. In the user's guide it is suggested to use as energy value the 

5.4 MeV and that was the initial value used for most simulations. However, the results were 

not the desired ones because the PDDs do not overlap completely, there was always a 

deviation indicating that the energy value of the electrons in the electron gun would be higher. 

Thereby, the energy of 6.26 MeV was experienced, because it was the energy used in the 

examples on the user’s guide manual. However, from the comparison with the Clinac 2300 

measured curves, it was concluded that the energy of the electrons would not be that one, 

because the calculated PDD was positioned slightly above the measured PDD. Thus, a new 

value of energy was experienced. In this case it was the 5.9 MeV. Here, the curves were quite 

coincident, but the calculated PDD still appeared to be slightly below the measured one. For 

this reason the procedure was repeated. At this time, the new value of energy tested was 6 

MeV. The comparison between PDD curves calculated and measured on the LINAC were very 

coincident, the most compatible so far. In Figure 4.9 is shown the percentage of passing points 

when calculated and measured PDD curves were compared in function of the energy. Looking 

to this graph it is not possible to clearly distinguish which are the best energies, because for all 

the energies there are percentages of passing points close to 100%, but there were also very 

bad results. This study was made by looking directly to every PDD curve obtained. This 

happens because the percentage of compatible values is influenced by other factors than the 

electrons energy, as we have seen previously. For example, in the case of the 6 MeV of energy, 

0 

20 

40 

60 

80 

100 

120 

0,00E+00 1,00E+07 2,00E+07 3,00E+07 

P
e

rc
e

n
ta

g
e

 (
%

) 

Histories 

Percentage of Passing points in 
function of the number of histories 

PDD (1% and 1mm) 



47 
 

it can be distinguished in the graph a simulation with a percentage of passing points less than 

20% and another in which the compatibility between both PDDs is around 100%. This occurred 

because in one of the simulations, the number of histories was much smaller than in the other. 

Consequently, it brings a lower statistics for the calculated PDD and therefore less consistent 

results, even when the simulation parameters are in accordance with the LINAC parameters in 

study. This change in energy affects essentially the PDD curve, not affecting much the lateral 

profiles. To adjust the lateral profiles, it is necessary to change another parameter in 

simulation S1 step, the focal spot. This change was done but it was observed that if the focal 

spot is too big, the lateral profiles lose their shape, showing with a more round shape (Figure 

4.10). The best value found for this parameter was 0.1 cm, in which the lateral profiles 

calculated and measured showed the same shape. The energy FWHM and the beam 

divergence also affects the calculated curves, in particular the lateral profiles. After the study 

of the variations in these two parameters they were fixed in 0.2 MeV and 1.5 deg, respectively. 

 

 

Figure 4.9 - Percentage of passing points as function of the energy. 

 

0 

20 

40 

60 

80 

100 

120 

5,2 5,4 5,6 5,8 6 6,2 6,4 

P
e

rc
e

n
ta

g
e

 (
%

) 

Energy (MeV) 

Percentage of passing points in 
function of Energy 

PDD (1% and 1mm) 



48 
 

 
Figure 4.10 – Illustration of lateral profile variation when increasing focal spot. 

 

Another parameter that needs our attention is the Variance Reduction Technique 

(VRT), since it affects the simulation results and speed. As these are simulations in whose 

nominal energy value remains constant in 6 MV, the VRT used will always be splitting roulette. 

This VRT is more efficient for energies below 15 MV than the rotational splitting option. The 

simulated field length was always the same (10x10 cm
2
). As this happens, the option "fitted to 

the field size" is chosen, which makes the simulation shorter. For this VRT the splitting factor 

parameter must be set, which in the user's guide indicates the value of 200. However, a study 

around this variable was performed in order to confirm that this was indeed the best value for 

splitting factor. In Figure 4.11 is shown how the variation of the splitting factor affects the 

agreement between the curves in comparison. It can be seen that a higher splitting factor 

doesn’t mean that the correlation between both curves will be higher. As a matter fact, it is 

possible to see that the best results occurred, in general, with a splitting factor below 500. 

Because of this, the splitting factor of 200 was maintained to all simulations, as suggested in 

the user’s guide manual, because it gives good results in a good amount of time. 

 



49 
 

 

Figure 4.11 - Percentage of passing points in function of splitting factor. 

 

Once these steps are completed, a PDD quite coincident with those acquired on 

Clinac 2300, in Porto IPO was achieved (Figure 4.12). But, to validate the software 

configuration, it is necessary that the simulated and measured lateral profiles are also 

compatible, which did not occur in the first simulations performed (Figure 4.13). Thus, it had to 

be confirmed if the simulated field size was in agreement with the measured field size. That 

was corroborated because the penumbra of both curves was compatible, which means that 

the calculated and measured field dimensions were the same. The differences between the 

lateral profiles were more based the umbra, which didn’t present the exactly shape in both 

curves. For this reason it was necessary to check the simulation grids defined in s3, because it 

is a parameter that has a big influence in the simulation results, because it can distort the 

examination of the obtained results. Thus, after several tests regarding the phantom setup, the 

conformation of Figure 4.14 was used. The main change made in this Setup was to check the 

box "shift phantom half bin along Z" and set the "depth of measurement" in 10.000 cm. This 

step changed the calculation grid making the previously calculated results well visible after this 

alteration. Therefore, curves which were not in agreement previously, making this small 

change became compatible, because the LINAC parameters were already well defined 

(according to Clinac 2300) and the calculation grid was properly adjusted. 

0 

20 

40 

60 

80 

100 

120 

0 500 1000 1500 2000 2500 

P
e

rc
e

n
ta

g
e

 (
%

) 

Splitting Factor 

Percentage of passing points in function 
of the splitting factor  

PDD (1% and 1mm) 

x (1% and 1mm) 

y (1% e 1mm) 



50 
 

 

Figure 4.12 - Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding PRIMO simulation. The 
gamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. 

 

Figure 4.13 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and corresponding PRIMO 
simulation. The gamma function analysis (2%, 2mm) showed that 90.54% of the points was lower than 1. 

 

 

Figure 4.14 – Phantom Setup. 



51 
 

Ending the study of all these parameters, PRIMO software was validated with a 

simulation of 2 weeks that resulted in 8.6x10
8
 histories simulated using the parameters already 

referred. This simulation generated the PDD presented in Figure 4.15 and the lateral profiles in 

Figure 4.16 and Figure 4.17. As can be seen there the curves simulated and measured are 

highly compatible, which makes possible PRIMO validation. These results are also the basis for 

all the remaining simulations to be carried out to complete the goals of this work. 

 

 

Figure 4.15 – Comparison between Clinac 2300 (DHX5) PDD from 2011 and corresponding PRIMO simulation. The 
gamma function analysis (2%, 2mm) showed that 99.66% of the points was lower than 1. 

 



52 
 

 

Figure 4.16 – Comparison between Clinac 2300 (DHX5) lateral profile X from 2011 and corresponding PRIMO 
simulation. The gamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. 

 

Figure 4.17 - Comparison between Clinac 2300 (DHX5) lateral profile Y from 2011 and corresponding PRIMO 
simulation. The gamma function analysis (2%, 2mm) showed that 100% of the points was lower than 1. 



53 
 

4.3 PRIMO output problem 
 

The simulation results made with PRIMO are shown in images and graphs, as can be 

seen in Figure 4.18. This output shows a dose distribution with a 10x10 cm
2
 open field 

simulated by PRIMO, for a given depth. However this output is given with an extension .dat, 

which means that a note pad document with a list of numbers is created. However, the most 

common programs used in radiotherapy to analyze these dose distributions does not read files 

with extension dat. or with this kind of data organization. Thus, the study of PRIMO results is a 

hard task to do using tools that do not belong to the program. Consequently, the comparison 

between PRIMO results with data from other programs is also difficult to perform because 

PRIMO only compares PDD curves and lateral profiles, but do not compare, for example, an 

image of a open field dose distribution. In the radiotherapy service, the majority of data from 

other programs come in dicom images or similar. For this reason, a way to convert the files 

from PRIMO to dicom images is necessary in order to compare both data and overcome this 

problem. This transformation is made based on Matlab functions, as it was already explained 

in Methodology. The process is a little bit complex and long because PRIMO notepad 

documents showed different data organization when the simulation is made using a CT scan of 

a slab phantom or a model from a water phantom. To reach these conclusions, it was 

necessary to previously analyze various PRIMO outputs, which are a big time consumer task, 

but an essential step to proceed with this work.  

In Figure 4.19 is shown the output of PRIMO already converted. Looking to both 

images (Figure 4.18 and Figure 4.19) it can be seen that they are the same image but with a 

different color scheme. However, as the image from Figure 4.19 was transformed in a dicom 

image it can be used in comparison tests with other programs as Verisoft or Doselab, which 

are used in clinical radiotherapy.  

 



54 
 

 

Figure 4.18 – PRIMO simulation results. 

 

Figure 4.19 – Image output created by MATLAB from PRIMO notepad document. 

 

4.4 MLC Tests 
 

Following the procedure described in the Methodology for MLC tests, the influence 

of the addition of an MLC was checked in an open field simulation. This simulates an 

irradiation in a Clinac 2300 with an open field, because the LINAC didn’t have only the jaws but 

also have the MLC and that’s what it is so important to do this test. The simulation performed 

didn’t show relevant differences from simulations with only the jaws present. Thus, the 

simulation performed was also compatible with the dose distribution acquired from a LINAC 

irradiation (Figure 4.20), as occurred with the simulation performed without the presence of 

the MLC. The dose distribution of an open field in a Clinac 2300 was also calculated in TPS and 

compared with the simulation in PRIMO (Figure 4.21) and with the irradiation in the LINAC 

(Figure 4.22). As expected, the results from the three modalities were compatible between 

them. The PRIMO simulation shown an agreement of 100% with the LINAC irradiation and of 

96,7% with TPS, using gamma index in clinical conditions (3%, 3mm). In its turn, the 

comparison between irradiated field and TPS had also an agreement of 100% using the same 

comparison conditions. The purpose of this test was to confirm the compatibility of the three 



55 
 

modalities, in order to be able to perform more complex tests, once the agreement between 

them was assured for open fields. 

 

 

Figure 4.20 - Comparison between PRIMO simulation and LINAC irradiation of an open field. 

 



56 
 

 

Figure 4.21 - Comparison between PRIMO simulation and TPS of an open field. 



57 
 

 

Figure 4.22- Comparison between TPS and LINAC irradiation of an open field. 

 

The next step in this process is to add a conformation to the MLC and perform 

compatibility tests for static fields. In this section will only be discussed one example of a static 

field, since it reflects the results from the other tests performed. This static field was chosen 

because the MLC leaves present the major variation tested. In this example the field borders 

were tested with close leaves in the top of the field and with open leaves in the opposite 

extreme and the remaining field was tested with all types of conformations for the different 

pairs of MLC leaves. The simulation results from PRIMO were transformed in dicom images 

and compared with the same static field irradiation in a Clinac 2300 and with a dose 

distribution from TPS.  In Figure 4.23 is shown the comparison between a static field simulated 

on PRIMO with the same field calculated with TPS. The comparison result shows a 

compatibility of 98.1%. This comparison was made using the gamma test with DTA of 3 mm 

and dose difference of 3 %, which are the criteria used in clinical practice. Looking to this 

result, the fields are in agreement, with compatibility bigger than 95% meaning that the 

simulation made with PRIMO, using Monte Carlo, is in accordance with the dose distribution 



58 
 

calculated by TPS. In Figure 4.24 the comparison between practical dose distribution and 

PRIMO results can be seen. They present an agreement of 100%, which means that the dose 

distribution calculated in PRIMO was the same irradiated by LINAC. Finally, in Figure 4.25 is 

shown a comparison between TPS calculation and a LINAC irradiation in order to prove by 

clinical means that both modalities have the same dose distribution. These results 

demonstrate that PRIMO works very well in dose distribution calculation for static fields, which 

makes possible to proceed the study, in order to prove the potentiality of PRIMO for IMRT 

treatments verification. At this stage, PRIMO simulation of conventional radiation therapy 

treatments was checked. 

 

 

Figure 4.23 – Comparison between PRIMO simulation and TPS of a static MLC field. 



59 
 

 

Figure 4.24 - Comparison between PRIMO simulation and LINAC irradiation of a static MLC field. 



60 
 

 

Figure 4.25 - Comparison between TPS and LINAC irradiation of a static MLC field. 

 

Continuing this work, it was time to begin the simulation of dynamic fields. This type of 

irradiation field intends to represent one IMRT field in step and shoot technique, which the 

dose is not uniform. In PRIMO, it is not possible to simulate one field with a non - uniform dose 

distribution. To accomplish this dynamic field it is necessary to simulate the superposition of 

several fields with different positions of the MLC leaves. In the end of the simulation, a non-

uniform dose distribution is obtained and it is composed by the sum of these 89 fields 

calculated. The same dynamic field simulated was also irradiated by LINAC in the PTW ion 

chamber matrix. The obtained results were compared with simulations using Verisoft. 

However, compatibility between them was hard to obtain and tests with gafchromic films 

were made to confirm dose distribution in the irradiated field. This technique was adopted 

since it is a more accurate way to analyze dose distributions, because gafchromic spatial 

resolution is higher than ion chamber matrix spatial resolution. Thus, a gafchromic film was 

irradiated with the dynamic field in study (Figure 4.26), and the ion chamber matrix was also 

irradiated with the same plan. The comparison of both showed an agreement of 98.8%, using 



61 
 

gamma test with 3%, and 3mm as criteria, the values used in clinical practice (Figure 4.27). 

After confirming that the dose distribution obtained with gafchromic films and with the matrix 

were compatible, the comparison tests with the matrix were repeated because it is less 

complicated to obtain and analyze results. When gafchromic is used the film irradiation is 

made in one day, and its analysis just can be done in the day after, adding the fact that 

gafchromic films require some care in its use. In its turn, using the PTW matrix, the field is 

irradiated and in a few minutes the results can be seen and analyzed, which for this type of 

work is more advantageous since the work scheme doesn’t change. Comparing the data from 

PTW matrix with PRIMO simulation, compatibility between both results was not the intended, 

revealing that data normalization has to be done. This normalization was made to the highest 

dose value, directly in Verisoft. In Figure 4.28 are the results from this process. The measured 

with the ion chamber matrix and simulated dose distributions show good agreement. The 

gamma function analysis (2%, 2mm) showed that 96% of the points were lower than 1, 

confirming that the simulated and experimental data were compatible. With this step was 

proved that PRIMO software has potential to be used in IMRT treatments verification, since it 

simulates with a good agreement IMRT fields in the IMRT step and shoot technique. 

 

 

Figure 4.26 – Gafchromic film after the dynamic field irradiation. 

 

 

Figure 4.27 – 2D Comparison obtained in Doselab between dynamic field measured with a gafchromic film and with 
the same measurement in ion chamber matrix. The gamma function analysis (3%, 3mm) showed that 98.8% of the 
points was lower than 1. 



62 
 

 

Figure 4.28 – A - Dose distribution for the dynamic IMRT treatment, measured with ionization chamber array, 
placed at 100 cm distance from the LINAC head under 5 cm of water equivalent. B – Dose distribution at the matrix 
for the simulated dynamic plan. C - Comparison between PRIMO simulation and LINAC irradiation of a dynamic MLC 
field. 

 

  



63 
 

5 Conclusions and Future Work 
 

IMRT is a radiation therapy technique that is widely used in Europe biggest 

radiotherapy centers. However, many smaller hospitals still not have this technique in their 

treatments, and others are dealing, only at this moment, with their implementation. Thus, 

although this is no longer a totally new technique, it still has a very great clinical significance. 

Therefore, nowadays the need of improving and developing the IMRT technique still exist. 

As mentioned before, IMRT is a conformal therapy technique, highly accurate, that 

allows the administration of high doses of radiation to the target volume, while dose is 

minimized, very effectively, to normal surrounding tissue.  To achieve this goal, a verification 

process is necessary before applying the treatment to a patient, in order to confirm if the TPS 

planned treatment and irradiated by LINAC are compatible. This compatibility, which is based 

on the gamma index at 3% and 3 mm, must be greater than 95%, which does not always occur. 

Completed this preliminary analysis it was concluded that combining Monte Carlo calculations 

to the verification process may be a way to reduce cases of non-compatibility. This was the 

reason why this project began, using PRIMO software, which is a program that promised to 

calculate dose distributions in a faster and more user friendly way. 

As PRIMO is a recent program, and once it was necessary to validate the LINAC to 

simulate, in the first work phase was unable to test the program in terms of simulation speed 

(when comparing it to other programs with the same purpose). However, on PRIMO first 

utilization, its user-friendly aspect is evident. Any person with minimal knowledge in 

informatics and MC simulations of a LINAC can perform a simulation, thinking that it is a 

program very simple to use and very intuitive. After a few times of utilization, it was realized 

that to obtain satisfactory results, it was necessary larger simulation times. However, 

compared to other programs it was concluded that this could be faster and more efficient, 

because PRIMO creates intermediate phase-space files (PHSP files) in each simulation stage, 

which could be reused. For example, in a simulation of s1, the reused of a PHSP file save weeks 

of simulation. However, until the program validation, simulations would have to be completed, 

to be able to identify the best parameters to use as LINAC parameters. 

The software validation was the most time-consuming task in this project, because it 

required longer simulations. For the obtainment of good statistical results, simulations 

performed in about 2 weeks were need. The validation process was the most time-consuming 

also because, as expected, the default data in PRIMO, for the simulated LINAC (the Clinac 

2300), did not have the desired compatibility degree with the IPO device used for comparisons. 



64 
 

For this reason, a discovery process of ideal parameters ideas begun by a trial error routine. 

After several simulations and elapsed many time, the ideal parameters to validate the PRIMO 

software were found. Thus, a longer simulation was performed with these parameters in order 

to be able to use the PHSP file in the following steps, saving the time used in s1 simulations. At 

the end of this first step, it was concluded that PRIMO user-friendly feature made the program 

validation much easier, giving that parameters influencing dose distributions were quite 

explicit: they were the only parameters that could be altered directly in PRIMO program. All 

other parameters that did not influence this task, such as those relating to LINAC construction 

are in a PHSP file that the program uses but does not give to the user the option to change. 

This saves time, because no simulations are carried out with alterations that do not directly 

affect the dose distribution. Looking to this fact, PRIMO can appear to be a "closed box" 

program, which for a kind of software like this is not an add-value. However, this PHSP files 

that PRIMO launch can be open as a text file and directly changed, avoiding this question of 

"closed box". In conclusion, this first step, besides validating PRIMO for simulation of the LINAC 

2300 present in Porto IPO, also allowed an adaptation and understanding of the program. 

In the second step of the project, MLC validation was performed, through the 

simulation of a field with a static MLC conformation. At this stage, problems in PRIMO results 

exportation were found. This situation forced the creation of alternatives to interpreting these 

results, including the creation of various MATLAB functions to read and transform PRIMO 

results in DICOM images. Another issue which is worth highlighting is the fact that PRIMO do 

not had all kind of MLC that could be present in the devices which PRIMO proposes to 

simulate. This is a question that must be taken into account initially, during the first uses of the 

program, in order to avoid the LINAC validation, and then the desired MLC does not exist in 

PRIMO, which requires that the validation process must be started over. Apart from these 

issues, this was a quick phase to execute, in which no adversities were found, in terms of 

compatibility between PRIMO simulations, TPS calculations and LINAC irradiation. Ending this 

phase, it is concluded that a conventional radiation treatment simulation would be perfectly 

performed using the PRIMO, given the compatibility obtained for static MLC.  

To complete this work, the simulation of a field using a dynamic MLC was performed. 

As PRIMO was not built with the initial idea of simulate non-conventional radiotherapy 

treatments, this was a more complicated task. For this reason, alternatives that allow going 

around this issue had to be found. Since IMRT treatments fall into two categories: the step and 

shot (also known as IMRT with MLC in segments) and IMRT with dynamic MLC; it was decided 

to focus only on step-and-shoot mode. As this mode not has a continuous irradiation, it can, in 

theory, be simulated quite reliably by PRIMO, even it not being predestined to non-



65 
 

conventional treatments simulation. The simulation of only one field of this modality is a long-

lasting process due to the amount of MLC position that needs to be acquired in each field. 

Once simulated the IMRT field (in step-and-shoot mode), the comparison between simulation, 

TPS and LINAC data was made. After some adjustments and according to a gamma index of 3% 

and 3mm (which are used in clinical practice), compatibility between the three modalities was 

found. Thus, it was concluded that PRIMO is able to simulate a complete IMRT treatment, 

since it can simulate a field of IMRT in step-and-shoot mode. Being possible the simulation of 

an IMRT treatment, it is also proved that PRIMO can be used in IMRT verification process, but 

with the disadvantage that it is a slower process than the current one. However, for more 

complex verification cases, this program can be very useful, given that the time to redo the 

treatment plan can be used to perform verification with PRIMO. Thus, it would be possible to 

better realize if the plan was or not the appropriate, or if the non-compatibility is due to an 

inadequate matrix interpolation. 

In the end of this project, it can be concluded that these were preliminary studies in 

order to use PRIMO in clinical practice into the future. This Master`s project proved the 

potential of PRIMO within IMRT radiotherapy technique (in step-and-shoot mode), but further 

work is required for simulating a complete IMRT treatment of a patient. An important issue 

that should be taken into account, at an earlier stage of testing, would be to perform 

simulations with different field sizes and more variations in MLC position. This wasn’t possible 

to achieve, due to the time needed to carry out these tests, and given the time predicted for 

this project realization. In the context of the work developed, it also should be done more 

dynamic field simulations, with a big variety of conformations, which was not made due to the 

reasons already explained. 

To continue this work from here, I leave as suggestion the simulation of various IMRT 

treatment fields of a patient (in step-and-shoot mode), using their CT and subsequent 

comparison with data from TPS and LINAC. This way, it will be effectively verified an IMRT 

treatment, proving not only the program potential for this purpose, but its present 

implementation. Another suggestion, a bit more complex, would be the simulation of IMRT 

treatments with dynamic MLC. Subsequently, the simulation of VMAT, another radiotherapy 

treatment technique, would be easier to perform, which would be a big step in MC simulation 

of non-conventional treatments. However, this is a work that, if being developed, will need 

many more tests and also some imagination to circumvent some program issues derived from 

its user-friendly feature, which is presented to the user as a kind of "closed box". 

As understood with this essay, PRIMO software presents a great potential in MC 

simulations field. Combine this software with IMRT treatments, which are one of the most 



66 
 

revolutionary radiotherapy techniques, could only end as an innovative idea, which brought 

new topics of discussion to this investigation field. Proving this fact, a communication coming 

from this master thesis was presented in ESTRO 35, one of the most important conferences in 

radiotherapy around the world, organized by the European Society for Radiotherapy &amp;amp; 

Oncology (ESTRO). 

  



67 
 

Bibliography 

[1] K. Chao, S. Apisarnthanarax, and G. Ozyigit, Practical Essentials of Intensity Modulated 
Radiation Therapy. Lippincott Williams &amp;amp; Wilkins, 2005. 

[2] L. Veldeman, I. Madani, F. Hulstaert, G. O. De Meerleer, M. Mareel, and W. De Neve, 
“Evidence behind use of intensity-modulated radiotherapy: a systematic review of 
comparative clinical studies.,” Lancet Oncol, vol. 9, no. 4, pp. 367–75, 2008. 

[3] S. I. Gutiontov, E. J. Shin, B. Lok, N. Y. Lee, and R. Cabanillas, “Intensity-modulated 
radiotherapy for head and neck surgeons,” Wiley Online Libr., vol. 119, no. 6, pp. 377–
382, 2015. 

[4] P. C. Williams, “IMRT: Delivery techniques and quality assurance,” Br. J. Radiol., vol. 76, 
no. 911, pp. 766–776, 2003. 

[5] A. Mesbahi, A. J. Reilly, and D. I. Thwaites, “Development and commissioning of a 
Monte Carlo photon beam model for Varian Clinac 2100EX linear accelerator,” Appl. 
Radiat. Isot., vol. 64, no. 6, pp. 656–662, 2006. 

[6] R. Capote, R. Jeraj, C.-M. Ma, D. W. O. Rogers, F. Sánchez-Doblado, J. Sempau, J. 
Seuntjens, and J. V. Siebers, “Phase-Space Database for External Beam Radiotherapy,” 
Vienna, 2006. 

[7] M. A. Cortés-Giraldo, J. M. Quesada, M. I. Gallardo, and R. Capote, “An implementation 
to read and write IAEA phase-space files in GEANT4-based simulations,” Int. J. Radiat. 
Biol., vol. 88, no. 1–2, pp. 200–208, 2012. 

[8] L. Brualla, M. Rodriguez, and J. Sempau, “PRIMO Project,” 2013. [Online]. Available: 
https://www.primoproject.net/primo/. 

[9] J. Pope, Medical Physics: Imaging. Oxford: Heinemann Educational Publishers, 1999. 

[10] P. Mayles, A. Nahum, and J. C. Rosenwald, Handbook of radiotherapy physics: theory 
and practice. Taylor &amp;amp; Francis Group, 2007. 

[11] E. B. Podgorsak, Radiation Oncology Physics: A Handbook for Teachers and Students. 
Vienna: IAEA, 2005. 

[12] J. M. Michalski, C. A. Perez, and J. A. Purdy, “Three-Dimensional Conformal Radiation 
Therapy (3DCRT) for Prostate Cancer,” The Prostate Cancer InfoLink, 1996. [Online]. 
Available: http://www.phoenix5.org/Infolink/Michalski/Part2.html. [Accessed: 26-Jun-



68 
 

2015]. 

[13] “Linear Accelerator,” RadiologyInfo.org, 2013. [Online]. Available: 
http://www.radiologyinfo.org/en/info.cfm?pg=linac. [Accessed: 23-Jun-2015]. 

[14] ICRP, “ICRP 103: The 2007 Recommendations of the International Commission on 
Radiological Protection,” Ann. ICRP, vol. 37, p. 330, 2007. 

[15] J. Izewska and G. Rajan, Review of Radiation Oncology Physics: A Handbook for Teachers 
and Students; Chapter 3 - RADIATION DOSIMETERS. IAEA, 2012. 

[16] PTW, “PTW Farmer® Ionization Chambers.” [Online]. Available: 
http://www.ptw.de/farmer_chambers0.html. [Accessed: 13-May-2016]. 

[17] M. C. Lopes, “Um século de terapia com radiação,” Gaz. Física, vol. 30, no. 14, pp. 14–
29, 2005. 

[18] “MP3-M,” PTW. [Online]. Available: http://www.ptw.de/2038.html. [Accessed: 05-Apr-
2016]. 

[19] F. M. Khan, The Physics of Radiation Therapy, 3rd ed. 2003. 

[20] E. E. Klein, J. Hanley, J. Bayouth, F.-F. Yin, W. Simon, S. Dresser, C. Serago, F. Aguirre, L. 
Ma, B. Arjomandy, C. Liu, C. Sandin, and T. Holmes, “Task Group 142 report: quality 
assurance of medical accelerators.,” Med. Phys., vol. 36, no. 9, pp. 4197–4212, 2009. 

[21] A. Taylor and M. E. B. Powell, “Intensity-modulated radiotherapy - What is it?,” Cancer 
Imaging, vol. 4, pp. 68–73, 2004. 

[22] T. S. Hong, M. a Ritter, W. a Tomé, and P. M. Harari, “Intensity-modulated radiation 
therapy: emerging cancer treatment technology.,” Br. J. Cancer, vol. 92, pp. 1819–1824, 
2005. 

[23] M. T. Milano, L. S. Constine, and P. Okunieff, “Normal Tissue Tolerance Dose Metrics for 
Radiation Therapy of Major Organs,” Semin. Radiat. Oncol., vol. 17, pp. 131–140, 2007. 

[24] T. Bortfeld, “IMRT: a review and preview.,” Phys. Med. Biol., vol. 51, no. 13, pp. R363–
R379, 2006. 

[25] M. Alber, S. Broggi, C. De Wagter, I. Eichwurzel, P. Engström, C. Fiorino, D. Georg, G. 
Hartmann, T. Knöös, A. Leal, H. Marijnissen, B. Mijnheer, M. Paiusco, F. Sánchez-



69 
 

Doblado, R. Schmidt, M. Tomsej, and H. Welleweerd, GUIDELINES FOR THE 
VERIFICATION OF IMRT. Brussels, 2008. 

[26] L. Gomes, “Estudo dosimétrico comparativo do Acuros ® XB – Algoritmo Avançado de 
Cálculo de dose com o AAA – Anisotropic Analytical Alghorithm , em tratamentos de 
Radioterapia Externa com a técnica de RapidArc 

TM
 Estudo dosimétrico comparativo do 

Acuros ® XB – Algori,” Escola Superior de Tecnologia da Saúde de Lisboa, 2013. 

[27] M. Scorsetti, A. Fogliata, B. Castiglioni, C. Bressi, M. Bignardi, P. Navarria, P. Mancuso, L. 
Cozzi, F. Alongi, and A. Santoro, “Early clinical experience with volumetric modulated 
arc therapy in head and neck cancer patients,” Radiat. Oncol., 2010. 

[28] K. Otto, “Volumetric Modulated Arc Therapy: IMRT in a single arc,” Med. Phys., vol. 35, 
pp. 310–317, 2008. 

[29] N. A. Detorie, “Helical Tomotherapy: A New Tool for Radiation Therapy,” J. Am. Coll. 
Radiol., vol. 5, no. 1, pp. 63–66, 2014. 

[30] C. X. Yu and G. Tang, “Intensity-modulated arc therapy: principles, technologies and 
clinical implementation,” Phys. Med. Biol., vol. 56, 2011. 

[31] G. MacLennan, “Precision Therapy Acronym Soup: SRS, SRT, SBRT, SAbR,” 2015. 
[Online]. Available: http://www.grayden.info/precision-therapy-acronym-soup-srs-srt-
sbrt-sabr.html. [Accessed: 06-Apr-2016]. 

[32] “Radiation Therapy for Cancer,” National Cancer Institute, 2010. [Online]. Available: 
http://www.cancer.gov/about-cancer/treatment/types/radiation-therapy/radiation-
fact-sheet. [Accessed: 25-Jun-2015]. 

[33] S. Goyal and T. Kataria, “Image Guidance in Radiation Therapy: Techniques and 
Applications,” Radiol. Res. Pract., vol. 2014, pp. 1–10, 2014. 

[34] S. Noda, T. Lautenschlaeger, M. R. Siedow, D. R. Patel, A. El-Jawahri, Y. Suzuki, J. S. 
Loeffler, M. R. Bussiere, and A. Chakravarti, “Technological advances in radiation 
oncology for central nervous system tumors.,” Semin. Radiat. Oncol., vol. 19, no. 3, pp. 
179–186, 2009. 

[35] Commissioning and Quality Assurance of Computerized Planning Systems for Radiation 
Treatment of Cancer. Austria, 2004. 

[36] D. Hinckley, “Prescribing, recording and reporting photon beam therapy (ICRU report 
50),” ICRU Rep., no. September, pp. 357–360, 1993. 



70 
 

[37] “Eclipse
TM

 Treatment Planning System,” Varian. [Online]. Available: 
https://www.varian.com/oncology/products/software/treatment-planning/eclipse. 

[38] M. G. Carolan, “Pencil Beam Dose Calculation Algorithm,” 2010. 

[39] I. M. Gagné and S. Zavgorodni, “Evaluation of the analytical anisotropic algorithm in an 
extreme water-lung interface phantom using Monte Carlo dose calculations,” J. Appl. 
Clin. Med. Phys., vol. 8, no. 1, pp. 33–46, 2007. 

[40] A. Sá, “Comparação entre o pencil beam convolution algorithm e o analytical 
anisotropic algorithm em tumores de mama,” 2013. 

[41] NCI, “The National Cancer Institute Guidelines for the Use of Intensity-Modulated 
Radiation Therapy in Clinical Trials.” 

[42] A. W. Beavis, “Is tomotherapy the future of IMRT?,” Br. J. Radiol., vol. 77, pp. 285–295, 
2004. 

[43] C. da S. Barros, “Estudo, avaliação e optimização em Radioterapia - IMRT,” Lisboa Univ. 
Nov. Lisboa, 2010. 

[44] A. L. D. S. Carvalho, “Implementação de um sistema de dosímetria ‘in-vivo’ em 
Radioterapia Externa – aplicação no cancro da mama,” Minho, 2009. 

[45] PTW, “OCTAVIUS® 729.” [Online]. Available: 
http://www.ptw.de/3099.html?&amp;amp;cId=3498. [Accessed: 29-Jun-2015]. 

[46] J. Seco and F. Verhaegen, Monte Carlo Techniques in Radiation Therapy. Taylor &amp;amp; 
Francis, 2013. 

[47] M. H. Kalos and P. a. Whitlock, Monte Carlo Methods. 2008. 

[48] F. Salvat, J. Fernández-Varea, and J. Sempau, PENELOPE-2006: A code system for Monte 
Carlo simulation of electron and photon transport, no. 6416. 2006. 

[49] R. Panait, I. Butuc, C. Constantin, M. Grivole, and D. Mihailescu, “Monte Carlo codes for 
use in medical radiation physics,” Lucr. în Ext. 

[50] L. Livermore, A. Bielajew, C. Hartmann-Siantar, I. Kawrakow, P. J. Keall, C.-M. Ma, A. 
Nahum, F. Salvat, and M. C. White, “MONTE CARLO TRANSPORT IN RADIOTHERAPY - 
CURRENT STATUS AND PROSPECTS , AND PHYSICAL DATA NEEDS,” no. 8, 2000. 



71 
 

[51] L. A. V. Quino, C. I. H. Hernandez, N. Papanikolaou, A. Gutierrez, C. Esquivel, T. Eng, M. 
Manciu, and S. Stathakis, “A Monte Carlo model for independent dose verification in 
IMRT and VMAT for the Varian Novalis TX with high definition MLC,” Int. J. Cancer Ther. 
Oncol., vol. 3, no. 3, pp. 1–7, 2015. 

[52] T. Goetzfried, M. Rickhey, M. Treutwein, O. Koelbl, and L. Bogner, “Monte Carlo 
simulations to replace film dosimetry in IMRT verification.,” Z. Med. Phys., vol. 21, no. 1, 
pp. 19–25, 2011. 

[53] M. F. Belosi, M. Rodriguez, A. Fogliata, L. Cozzi, J. Sempau, A. Clivio, G. Nicolini, E. 
Vanetti, H. Krauss, C. Khamphan, P. Fenoglietto, J. Puxeu, D. Fedele, P. Mancosu, and L. 
Brualla, “Monte Carlo simulation of TrueBeam flattening-filter-free beams using varian 
phase-space files: comparison with experimental data.,” Med. Phys., vol. 41, no. 2013, 
p. 051707, 2014. 

[54] J. Sempau, A. Badal, and L. Brualla, “A PENELOPE-based system for the automated 
Monte Carlo simulation of clinacs and voxelized geometries—application to far-from-
axis fields,” Med. Phys., vol. 38, no. 2011, p. 5887, 2011. 

[55] M. Rodriguez, J. Sempau, and L. Brualla, “PRIMO: A graphical environment for the 
Monte Carlo simulation of Varian and Elekta linacs,” Strahlenther Onkol, vol. 189, pp. 
881–886, 2013. 

[56] D. a Low and J. F. Dempsey, “Evaluation of the gamma dose distribution comparison 
method.,” Med. Phys., vol. 30, pp. 2455–2464, 2003. 

[57] L. Brualla, M. Rodriguez, and J. Sempau, PRIMO User ’ s Manual. 2014. 

[58] T. Depuydt, A. Van Esch, and D. P. Huyskens, “A quantitative evaluation of IMRT dose 
distributions: Refinement and clinical assessment of the gamma evaluation,” Radiother. 
Oncol., vol. 62, pp. 309–319, 2002. 

[59] Mephysto, “Appendix D?: Analysis Parameters for Photon Depth Dose Curves.” 2014. 

[60] Mephysto, “Appendix B?: Analysis Parameters for Profiles.” 2014. 

   



 

 

 

 

 

Appendices 
  



ii 
 

Appendix A 
 

In Appendix A is presented all the Matlab functions used to transform PRIMO output in DICOM 

images. These functions also allow the sum of several fields, if needed, building one IMRT field.  

 

A.1.  Functions to write a new PRIMO file 
 

%Function to write new PRIMO File 

 

function WritePRIMOFile(inputAddressList, WeightList, outputAddress, 

WhichIsLast, selection) 

  
switch selection 
    case 'CT' 
        [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = 

ReadPRIMOAllFileCT(WhichIsLast, inputAddressList, WeightList); 
    case 'Box' 
        [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = 

ReadPRIMOAllFile(WhichIsLast, inputAddressList, WeightList); 
    otherwise 
        error('invalid selection') 
end 

  
fid = fopen(outputAddress,'wt'); 

  
switch selection 
    case 'CT' 
        SavePhantomFileCT(MatMedia, Voxels, VoxelsPos, VoxelsDim, 

nParticlesSum, WhichIsLast, fid); 
    case 'Box' 
        SavePhantomFile(MatMedia, Voxels, VoxelsPos, VoxelsDim, 

nParticlesSum, WhichIsLast, fid); 
    otherwise 
        error('invalid selection') 
end 

  
fclose(fid); 

 

%Function to write PRIMO File Header 

 

function WritePRIMOFileHeader(Voxels, MinValues, BinWidths, fid) 

  
fprintf(fid, '%s\n', 

'#&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;'); 
fprintf(fid, '%s\n', '# [SECTION REPORT SPATIAL DOSE DISTRIB]'); 
fprintf(fid, '%s\n', '# Dose units are: eV/g per history'); 
fprintf(fid, '%s\n', '# No. of bins in x,y,z directions:'); 
fprintf(fid, '#  %d %d %d\n', Voxels); 
fprintf(fid, '%s\n', '# Min values and bin widths for x,y,z(cm):'); 
fprintf(fid, '#   %7.5E  %7.5E  %7.5E  %7.5E  %7.5E  %7.5E\n', 

MinValues(1), BinWidths(1), MinValues(2), BinWidths(2), MinValues(3), 

BinWidths(3)); 
fprintf(fid, '%s\n', '#'); 



iii 
 

fprintf(fid, '%s\n', '# For plotting purposes, two values per bin 

coordinate are given, namely,'); 
fprintf(fid, '%s\n', '#   the low end and the middle point of each 

bin'); 
fprintf(fid, '%s\n', '#'); 
fprintf(fid, '%s', '# xBinIndex : xLow(cm) : xMiddle(cm) : yBinIndex : 

yLow(cm) : yMiddle(cm) : zBinIndex : zLow(cm) : zMiddle(cm) : dose : 

+-2sigma'); 

 

%Function to write PRIMO File Footer 

 

function WritePRIMOFileFooter(nParticles, WhichIsLast, fid) 

  
fprintf(fid, '\n\n\n'); 

  
if WhichIsLast~=0 
    fprintf(fid, '# Performance report\n'); 
    fprintf(fid, '#   Random seeds:\n'); 
    fprintf(fid, '#   1\n'); 
    fprintf(fid, '#   2\n'); 
    fprintf(fid, '#   No. of histories simulated [N]:\n'); 
    fprintf(fid, '#              %d\n', nParticles); 
    fprintf(fid, '#   CPU time [t] (s):\n'); 
    fprintf(fid, '#    4.40843E+02\n'); 
    fprintf(fid, '#   Speed (histories/s):\n'); 
    fprintf(fid, '#    1.04991E+03\n'); 
    fprintf(fid, '#   Average uncertainty (above 1/2 max score) in %% 

[uncert]:\n'); 
    fprintf(fid, '#    1.70386E+02\n'); 
    fprintf(fid, '#   Intrinsic efficiency [N*uncert^2]^-1:\n'); 
    fprintf(fid, '#    7.44211E-11\n'); 
    fprintf(fid, '#   Absolute efficiency [t*uncert^2]^-1:\n'); 
    fprintf(fid, '#    7.81352E-08\n'); 
    fprintf(fid, '#\n'); 
end 

  
WritePRIMOFile2ndFooter(nParticles, fid); 

 

%Function to write PRIMO File Second Footer 

 

function WritePRIMOFile2ndFooter(nParticles, fid) 

  
fprintf(fid, '#\n'); 
fprintf(fid, '# The dose was integrated from NNN parallel simulation 

processes.\n#\n#\n#\n'); 
fprintf(fid, '# Final performance report\n'); 
fprintf(fid, '#   No. of histories simulated [N]:\n'); 
fprintf(fid, '#           %d\n', nParticles); 
fprintf(fid, '#   Speed (histories/s):\n'); 
fprintf(fid, '#      12509.07\n'); 
fprintf(fid, '#   Average uncertainty (above 1/2 max score) in %% 

[uncert]:\n'); 
fprintf(fid, '#      38.561\n'); 
fprintf(fid, '#   Intrinsic efficiency [N*uncert^2]^-1:\n'); 
fprintf(fid, '#      1.20287E-010\n'); 
fprintf(fid, '#   Absolute efficiency [t*uncert^2]^-1:\n'); 



iv 
 

fprintf(fid, '#      1.50468E-006\n#\n'); 
fprintf(fid, '# Have a nice day.\n'); 

 

A.2. Functions to read and interpret PRIMO files using a slab phantom 

in the simulation 
 

%Function to read PRIMO complete File 

 

function [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = 

ReadPRIMOAllFile(WhichIsLast, inputAddressList, WeightList) 

  
MatsList = cell(size(inputAddressList)); 
HeadersList = cell(size(inputAddressList)); 
FootersList = cell(size(inputAddressList)); 

  
nParticleList = zeros(size(inputAddressList)); 

  
S = size(MatsList); 

  
Voxels = [0, 0, 0]; 
VoxelTest = [0 0 0]; 

  
VoxelsDim = [0, 0, 0]; 
VoxelsDimTest = [0 0 0]; 

  
VoxelsPos = [0, 0, 0]; 
VoxelsPosTest = [0 0 0]; 

  
WeightSum = 0; 
nParticlesSum = 0; 
FactorSum = 0; 

  
for ii=1:1:S(2) 

     
    sprintf('\nReading Field %d\n', ii) 

     
    if WhichIsLast==0 
        [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFile(char(inputAddressList(ii)), 1); 
    else 
        if ii~=WhichIsLast 
            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFile(char(inputAddressList(ii)), 1); 
        else 
            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFile(char(inputAddressList(ii)), 0); 
        end 
    end 

     
    sprintf('\nEnd Reading Field %d\n\n', ii) 

     
    if ii==1 
        MatMedia = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); 
        for nn=1:1:9 
            MatMedia(:, nn) = Mat(:, nn); 
        end 
    end 



v 
 

     
    if ii==1 
        VoxelTest = Voxels; 
        VoxelsDimTest = VoxelsDim; 
        VoxelsPosTest = VoxelsPos; 
    else 
        if ((isequal(Voxels, VoxelTest) == 0) || (isequal(VoxelsDim, 

VoxelsDimTest) == 0) || (isequal(VoxelsPos, VoxelsPosTest) == 0)); 
            error('Voxel numbers are different.... Check carefully 

your files!') 
        end 
    end 
    WeightSum = WeightSum + WeightList(ii); 

     
    nParticles; 

     
    nParticleList(ii) = nParticles; 
    nParticlesSum = nParticlesSum + nParticles; 
    FactorSum = FactorSum + WeightList(ii)*nParticles; 

     
    MatMedia = CalculatePRIMOMedia(MatMedia, Mat, nParticleList(ii), 

WeightList(ii)); 

     
end 

  
MatMedia(:, 10) = MatMedia(:,10)/FactorSum; 
 

 

%Function to read PRIMO File (header and footer) 

 

function [MatOut, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFile(inputAddress, islast) 

  
format shortG 

  
fid = fopen(inputAddress); 

  
LineWith_nVox = 5; 

  
LineWith_VoxDim = 7; 

  
HeaderRows = 12; 

  
Voxels = [0, 0, 0]; 

  
[Voxels, VoxelsDim, VoxelsPos] = ReadHeader(HeaderRows, fid, 

LineWith_nVox, LineWith_VoxDim); 

  
delimiterIn = ' '; 

 
MatOut = fscanf(fid, '%d %f %f %d %f %f %d %f %f %f %f', [11 

Voxels(1)*Voxels(2)*Voxels(3)]); 
MatOut = MatOut'; 

  
LineWith_nParticles = 0; 
if islast == 0 
    LineWith_nParticles = 12; 
else 



vi 
 

    LineWith_nParticles = 29; 
end 

  
FooterRows = 36; 

  
nParticles = 0; 

  
nParticles = ReadFooter(FooterRows, fid, LineWith_nParticles); 

  
fclose(fid); 

 

%Function to read header 

 

function [Voxels, VoxelsDim, VoxelsPos] = ReadHeader(HeaderRows, fid, 

LineWith_nVox, LineWith_VoxDim) 

  
for ii=1:1:HeaderRows 
    Row = fgetl(fid); 
    if ii==LineWith_nVox 
        Voxels = ReadNumVoxelsFromHeader(Row); 
    end 

     
    if ii==LineWith_VoxDim 
        [VoxelsDim] = ReadVoxelDimFromHeader(Row); 
        [VoxelsPos] = ReadVoxelPosFromHeader(Row); 
    end 
end 
 

%Function to read voxel number from header 

 

function [Voxels] = ReadNumVoxelsFromHeader(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 
Voxels = str2num(Row); 

 

%Function to read voxel dimensons from header 

 

function VoxelsDim = ReadVoxelDimFromHeader(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 
Num = str2num(Row); 

  
VoxelsDim = [Num(2) Num(4) Num(6)]; 

 

%Function to read voxel position from header 

 

function VoxelsDim = ReadVoxelPosFromHeader(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 



vii 
 

Num = str2num(Row); 

  
VoxelsDim = [Num(1) Num(3) Num(5)]; 

 

%Function to read footer 

 

function [nParticles] = ReadFooter(FooterRows, fid, 

LineWith_nParticles) 

  
FooterExt = ''; 

  
for ii=1:1:FooterRows 
    Row = fgetl(fid); 
   if ii==LineWith_nParticles 
        nParticles = ReadnParticlesFromFooter(Row); 
   end 
end 

 

 

%Function to read number of particles in footer 

 

function [nParticles] = ReadnParticlesFromFooter(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 
nParticles = str2num(Row); 

 

 

%Function to calculate PRIMO mean values 

 

function MatMediaOut = CalculatePRIMOMedia(MatMedia, Mat, nParticles, 

Weight) 

  
sprintf('\nSumming up Weighted Matrixes\n'); 

  
MatMediaOut(:, 10) = MatMedia(:, 10) + (Weight*nParticles)*Mat(:, 10); 
MatMediaOut(:, 11) = 0; 

  
sprintf('\nMatrixes Summed\n'); 

 

 

 
%Function to save phantom file 

 

 
function SavePhantomFile(MatMedia, Voxels, VoxelsPos, VoxelsDim, 

nParticlesSum, WhichIsLast, fid) 

  
WritePRIMOFileHeader(Voxels, VoxelsPos, VoxelsDim, fid); 

  
MatDose = reshape(MatMedia(:, 10), Voxels); 
MatUncertainty = reshape(MatMedia(:, 11), Voxels); 

  
for ii=1:1:Voxels(3) 
    for jj=1:1:Voxels(2) 
        for kk=1:1:Voxels(1) 



viii 
 

            fprintf(fid, '\n%d %7.5E %7.5E %d %7.5E %7.5E %d %7.5E 

%7.5E %7.5E %7.5E', kk, VoxelsPos(1)+(kk-1)*VoxelsDim(1), 

VoxelsPos(1)+(kk-1)*VoxelsDim(1)+VoxelsDim(1)/2, jj, VoxelsPos(2)+(jj-

1)*VoxelsDim(2), VoxelsPos(2)+(jj-1)*VoxelsDim(2)+VoxelsDim(2)/2, ii, 

VoxelsPos(3)+(ii-1)*VoxelsDim(3), VoxelsPos(3)+(ii-

1)*VoxelsDim(3)+VoxelsDim(3)/2, MatDose(kk, jj, ii), 

MatUncertainty(kk, jj, ii)); 
        end 
        fprintf(fid, '\n'); 
    end 
end 

  
WritePRIMOFileFooter(nParticlesSum, WhichIsLast, fid); 

 

 

 
%Function to create image 

 

function CreateImageFromBox(inputAddress, filter, selection, 

inputmetadata, islast, saveAddress) 

  
[MatIn, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFile(inputAddress, islast); 

  
Voxels 
VoxelsDim 
VoxelsPos 
nParticles 

  
MatOut = zeros(VoxelsDim(1)*VoxelsDim(2)*VoxelsDim(3), 11); 

  
x = zeros(Voxels(1)); 
y = zeros(Voxels(2)); 
z = zeros(Voxels(3)); 

  
for ii=1:1:Voxels(1) 
    x(ii) = VoxelsPos(1) + (ii-1)*VoxelsDim(1); 
end 

  
for jj=1:1:Voxels(2) 
    y(jj) = VoxelsPos(2) + (jj-1)*VoxelsDim(2); 
end 

  
for kk=1:1:Voxels(3) 
    z(kk) = VoxelsPos(3) + (kk-1)*VoxelsDim(3); 
end 

  
for ii=1:1:Voxels(1) 
    for jj=1:1:Voxels(2) 
        for kk=1:1:Voxels(3) 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),1) = ii; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),3) = x(ii) + VoxelsDim(1)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),2) = x(ii); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),4) = jj; 



ix 
 

            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),6) = y(jj) + VoxelsDim(2)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),5) = y(jj); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),7) = kk; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),9) = z(kk) + VoxelsDim(3)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),8) = z(kk); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),10) = MatIn(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2), 10); 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),11) = MatIn(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2), 11); 
        end 
    end 
end 

  
metadata = load(inputmetadata); 

  
S = size(selection); 

  
for ii=1:1:S(2) 
    selection(1, ii); 
    switch filter 
        case 'x' 
            MatSelect = 

MatOut(double(MatOut(:,3))==double(selection(1, ii)), :); 
            Voxels2D = [1, Voxels(2), Voxels(3)]; 
            metadata.metadata.Rows = Voxels(2); 
            metadata.metadata.Columns = Voxels(3); 
            PixSpac = [VoxelsDim(1) VoxelsDim(2)]; 
            metadata.metadata.Width = Voxels(2); 
            metadata.metadata.Height = Voxels(3); 
        case 'xVoxIndex' 
            MatSelect = MatOut(MatOut(:,1)==selection(1, ii), :); 
            Voxels2D = [1, Voxels(2), Voxels(3)]; 
            metadata.metadata.Rows = Voxels(2); 
            metadata.metadata.Columns = Voxels(3); 
            PixSpac = [VoxelsDim(1) VoxelsDim(2)]; 
            metadata.metadata.Width = Voxels(2); 
            metadata.metadata.Height = Voxels(3); 
        case 'y' 
            MatSelect = 

MatOut(double(MatOut(:,6))==double(selection(1, ii)), :); 
            Voxels2D = [Voxels(1), 1, Voxels(3)]; 
            metadata.metadata.Rows = Voxels(1); 
            metadata.metadata.Columns = Voxels(3); 
            PixSpac = [VoxelsDim(3) VoxelsDim(1)]; 
            metadata.metadata.Width = Voxels(1); 
            metadata.metadata.Height = Voxels(3); 
        case 'yVoxIndex' 
            MatSelect = MatOut(MatOut(:,4)==selection(1, ii), :); 
            Voxels2D = [Voxels(1), 1, Voxels(3)]; 
            metadata.metadata.Rows = Voxels(1); 
            metadata.metadata.Columns = Voxels(3); 



x 
 

            PixSpac = [VoxelsDim(3) VoxelsDim(1)]; 
            metadata.metadata.Width = Voxels(1); 
            metadata.metadata.Height = Voxels(3); 
        case 'z' 
            MatSelect = 

MatOut(double(MatOut(:,9))==double(selection(1, ii)), :); 
            Voxels2D = [Voxels(1), Voxels(2), 1]; 
            metadata.metadata.Rows = Voxels(1); 
            metadata.metadata.Columns = Voxels(2); 
            PixSpac = [VoxelsDim(2) VoxelsDim(1)]; 
            metadata.metadata.Width = Voxels(1); 
            metadata.metadata.Height = Voxels(2); 
        case 'zVoxIndex' 
            MatSelect = MatOut(MatOut(:,7)==selection(1, ii), :); 
            Voxels2D = [Voxels(1), Voxels(2), 1]; 
            metadata.metadata.Rows = Voxels(1); 
            metadata.metadata.Columns = Voxels(2); 
            PixSpac = [VoxelsDim(2) VoxelsDim(1)]; 
            metadata.metadata.Width = Voxels(1); 
            metadata.metadata.Height = Voxels(2); 
        otherwise 
            error('invalid selection') 
    end 

  
    str = strcat(saveAddress, sprintf('_%d.dcm', selection(ii))) 
    metadata.metadata.Filename = str; 

  
    MatSelect = squeeze(reshape(MatSelect(:,10), Voxels2D)); 

     
    dicomwrite(imrotate(MatSelect, -90), str, metadata, 'CreateMode', 

'Copy', 'PixelSpacing', 10*PixSpac, 'SOPClassUID', 

'1.2.840.10008.5.1.4.1.1.2', 'MultiframeSingleFile', true); 
end 

 

 

A.2. Functions to read and interpret PRIMO files using a CT image in the 

simulation 
 

%Function to read PRIMO complete File  

 

function [MatMedia, Voxels, VoxelsDim, VoxelsPos, nParticlesSum] = 

ReadPRIMOAllFileCT(WhichIsLast, inputAddressList, WeightList) 

  
nParticleList = zeros(size(inputAddressList)); 

  
S = size(inputAddressList) 

  
Voxels = [0, 0, 0]; 
VoxelTest = [0 0 0]; 

  
VoxelsDim = [0, 0, 0]; 
VoxelsDimTest = [0 0 0]; 

  
VoxelsPos = [0, 0, 0]; 
VoxelsPosTest = [0 0 0]; 

  
WeightSum = 0; 



xi 
 

nParticlesSum = 0; 
FactorSum = 0; 

  
for ii=1:1:S(2) 

     
    sprintf('\nReading Field %d\n', ii) 

     
    if WhichIsLast==0 
        [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFileCT(char(inputAddressList(ii)), 1); 
    else 
        if ii~=WhichIsLast 
            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFileCT(char(inputAddressList(ii)), 1); 
        else 
            [Mat, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFileCT(char(inputAddressList(ii)), 0); 
        end 
    end 

     
    sprintf('\nEnd Reading Field %d\n\n', ii) 

     
    if ii==1 
        MatMedia = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); 
        for nn=1:1:9 
            MatMedia(:, nn) = Mat(:, nn); 
        end 
    end 

     
    if ii==1 
        VoxelTest = Voxels; 
        VoxelsDimTest = VoxelsDim; 
        VoxelsPosTest = VoxelsPos; 
    else 
        if ((isequal(Voxels, VoxelTest) == 0) || (isequal(VoxelsDim, 

VoxelsDimTest) == 0) || (isequal(VoxelsPos, VoxelsPosTest) == 0)); 
            error('Voxel numbers are different.... Check carefully 

your files!') 
        end 
    end 
    WeightSum = WeightSum + WeightList(ii); 

     
    nParticles; 

     
    nParticleList(ii) = nParticles; 
    nParticlesSum = nParticlesSum + nParticles; 
    FactorSum = FactorSum + WeightList(ii)*nParticles; 

     
    MatMedia = CalculatePRIMOMediaCT(MatMedia, Mat, nParticleList(ii), 

WeightList(ii)); 

     
end 

  
MatMedia(:, 10) = MatMedia(:,10)/FactorSum; 

 

 
%Function to read PRIMO File (header and footer) 

 



xii 
 

function [MatOut, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFileCT(inputAddress, islast) 

  
format shortG 

  
fid = fopen(inputAddress); 

  
LineWith_nVox = 8; 

  
LineWith_VoxelDim = 10; 

  
HeaderRows = 11; 

  
[Voxels, VoxelsDim, VoxelsPos] = ReadHeaderCT(HeaderRows, fid, 

LineWith_nVox, LineWith_VoxelDim); 

  
Voxels 
VoxelsDim 
VoxelsPos 

  
MatOut = zeros(Voxels(1)*Voxels(2)*Voxels(3), 11, 'double'); 

  
for kk=1:1:Voxels(3) 
    [zVoxIndex middleZ] = ReadCTsingleVoxLine(fid); 
    for jj=1:1:Voxels(2) 
        [yVoxIndex middleY] = ReadCTsingleVoxLine(fid); 
        for ii=1:1:Voxels(1) 
            index = ii + Voxels(1)*(jj -1) + Voxels(1)*Voxels(2)*(kk-

1); 
            MatOut(index, 1) = ii; 
            MatOut(index, 2) = VoxelsPos(1) - VoxelsDim(1)/2 + (ii - 

1)*VoxelsDim(1); 
            MatOut(index, 3) = MatOut(index, 2) + VoxelsDim(1)/2; 
            MatOut(index, 4) = jj; 
            MatOut(index, 5) = middleY - VoxelsDim(2)/2; 
            MatOut(index, 6) = middleY; 
            MatOut(index, 7) = kk; 
            MatOut(index, 8) = middleZ - VoxelsDim(3)/2; 
            MatOut(index, 9) = middleZ; 
            MatOut(index, 10) = fscanf(fid, '%f', 1); 
            MatOut(index, 11) = fscanf(fid, '%f', 1); 
        end 
        fscanf(fid, '\n'); 
    end 
    fscanf(fid, '\n'); 
end 

  
LineWith_nParticles = 0; 
if islast == 0 
    FooterRows = 18; 
    LineWith_nParticles = 8; 
else 
    FooterRows = 35; 
    LineWith_nParticles = 25; 
end 

  
nParticles = 0; 

  
nParticles = ReadFooterCT(FooterRows, fid, LineWith_nParticles); 



xiii 
 

  
nParticles 

  
fclose(fid); 

 

 

%Function to read header 

 

function [Voxels, VoxelsDim, VoxelsPos] = ReadHeaderCT(HeaderRows, 

fid, LineWith_nVox, LineWith_VoxDim) 

  
for ii=1:1:HeaderRows 
    Row = fgetl(fid); 

     
    if ii==LineWith_nVox 
        Voxels = ReadNumVoxelsFromHeaderCT(Row); 
    end 

     
    if ii==LineWith_VoxDim 
        VoxelsDim = ReadVoxelDimFromHeaderCT(Row); 
    end 
end 

  
position = ftell(fid); 

  
Row = fgetl(fid); 
[Values count] = ReadVoxelzPosFromHeaderCT(Row); 
VoxelsPos(3) = Values(1) - VoxelsDim(3)/2; 

  
Row = fgetl(fid); 
[Values count] = ReadVoxelyPosFromHeaderCT(Row); 
VoxelsPos(2) = Values(1) - VoxelsDim(2)/2; 

  
VoxelsPos(1) = -Voxels(1)*VoxelsDim(1)/2 +VoxelsDim(1)/2; 

  
Voxels; 
VoxelsDim; 
VoxelsPos; 

  
fseek(fid, position, 'bof'); 

 

 
%Function to read voxel number from header 

 

function [Voxels] = ReadNumVoxelsFromHeaderCT(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 
Voxels = str2num(Row); 

 

%Function to read voxel dimensons from header 

 

function [VoxelsDim] = ReadVoxelDimFromHeaderCT(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 



xiv 
 

VoxelsDim = str2num(Row); 

 

%Function to read voxel position in y from header 

 

function [index VoxelsPos] = ReadVoxelyPosFromHeaderCT(Row) 

  
[index VoxelsPos] = sscanf(Row, '# yVoxIndex=%d yMiddle(cm)= %f'); 

 

 

%Function to read voxel position in z from header 

 

function [index VoxelsPos] = ReadVoxelzPosFromHeaderCT(Row) 

  
[index VoxelsPos] = sscanf(Row, '# zVoxIndex=%d zMiddle(cm)= %f'); 

 

 

%Function to read footer 

 

function [nParticles] = ReadFooterCT(FooterRows, fid, 

LineWith_nParticles) 

  
FooterRows; 
LineWith_nParticles; 

  
FooterExt = ''; 

  
for ii=1:1:FooterRows 
    Row = fgetl(fid); 
   if ii==LineWith_nParticles 
       nParticles = ReadnParticlesFromFooter(Row); 
   end 
end 

 

 
%Function to read number of particles in footer 

 
function [nParticles] = ReadnParticlesFromFooter(Row) 

  
S = size(Row); 
Row = strtrim(Row(1,2:S(2))); 
nParticles = str2num(Row); 

 

 
%Function to calculate PRIMO mean values 

 
function MatMediaOut = CalculatePRIMOMediaCT(MatMedia, Mat, 

nParticles, Weight) 

  
sprintf('\nSumming up Weighted Matrixes\n'); 

  
MatMediaOut(:, 10) = MatMedia(:, 10) + (Weight*nParticles)*Mat(:, 10); 
MatMediaOut(:, 11) = 0; 

  
sprintf('\nMatrixes Summed\n'); 

 



xv 
 

 
%Function to save phantom file 

 

function SavePhantomFileCT(MatMedia, Voxels, VoxelsPos, VoxelsDim, 

nParticlesSum, WhichIsLast, fid) 

  
WritePRIMOFileHeader(Voxels, VoxelsPos, VoxelsDim, fid); 

  
MatDose = reshape(MatMedia(:, 10), Voxels); 
MatUncertainty = reshape(MatMedia(:, 11), Voxels); 

  
for ii=1:1:Voxels(3) 
    for jj=1:1:Voxels(2) 
        for kk=1:1:Voxels(1) 
            fprintf(fid, '\n%d %7.5E %7.5E %d %7.5E %7.5E %d %7.5E 

%7.5E %7.5E %7.5E', kk, VoxelsPos(1)+(kk-1)*VoxelsDim(1), 

VoxelsPos(1)+(kk-1)*VoxelsDim(1)+VoxelsDim(1)/2, jj, VoxelsPos(2)+(jj-

1)*VoxelsDim(2), VoxelsPos(2)+(jj-1)*VoxelsDim(2)+VoxelsDim(2)/2, ii, 

VoxelsPos(3)+(ii-1)*VoxelsDim(3), VoxelsPos(3)+(ii-

1)*VoxelsDim(3)+VoxelsDim(3)/2, MatDose(kk, jj, ii), 

MatUncertainty(kk, jj, ii)); 
        end 
        fprintf(fid, '\n'); 
    end 
end 

  
WritePRIMOFileFooter(nParticlesSum, WhichIsLast, fid); 

 
 

%Function to create image 

 

function CreateImageFromCT(inputAddress, filter, selection, 

inputmetadata, islast, saveAddress) 

  
[MatIn, Voxels, VoxelsDim, VoxelsPos, nParticles] = 

ReadPRIMOFileCT(inputAddress, islast); 

  
Voxels 
VoxelsDim 
VoxelsPos 
nParticles 

  
MatOut = zeros(VoxelsDim(1)*VoxelsDim(2)*VoxelsDim(3), 11); 

  
x = zeros(Voxels(1)); 
y = zeros(Voxels(2)); 
z = zeros(Voxels(3)); 

  
for ii=1:1:Voxels(1) 
    x(ii) = VoxelsPos(1) + (ii-1)*VoxelsDim(1); 
end 

  
for jj=1:1:Voxels(2) 
    y(jj) = VoxelsPos(2) + (jj-1)*VoxelsDim(2); 
end 

  
for kk=1:1:Voxels(3) 
    z(kk) = VoxelsPos(3) + (kk-1)*VoxelsDim(3); 
end 



xvi 
 

  
for ii=1:1:Voxels(1) 
    for jj=1:1:Voxels(2) 
        for kk=1:1:Voxels(3) 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),1) = ii; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),3) = x(ii) + VoxelsDim(1)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),2) = x(ii); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),4) = jj; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),6) = y(jj) + VoxelsDim(2)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),5) = y(jj); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),7) = kk; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),9) = z(kk) + VoxelsDim(3)/2; 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),8) = z(kk); 

             
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),10) = MatIn(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2), 1); 
            MatOut(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2),11) = MatIn(ii + (jj-1)*Voxels(1) + (kk-

1)*Voxels(1)*Voxels(2), 2); 
        end 
    end 
end 

  
metadata = load(inputmetadata); 

  
switch filter 
    case 'x' 
        MatSelect = MatOut(double(MatOut(:,3))==double(selection), :); 
        Voxels2D = [1, Voxels(2), Voxels(3)]; 
        metadata.metadata.Rows = Voxels(2); 
        metadata.metadata.Columns = Voxels(3); 
        PixSpac = [VoxelsDim(1) VoxelsDim(2)]; 
        metadata.metadata.Width = Voxels(2); 
        metadata.metadata.Height = Voxels(3); 
    case 'xVoxIndex' 
        MatSelect = MatOut(MatOut(:,1)==selection, :); 
        Voxels2D = [1, Voxels(2), Voxels(3)]; 
        metadata.metadata.Rows = Voxels(2); 
        metadata.metadata.Columns = Voxels(3); 
        PixSpac = [VoxelsDim(1) VoxelsDim(2)]; 
        metadata.metadata.Width = Voxels(2); 
        metadata.metadata.Height = Voxels(3); 
    case 'y' 
        MatSelect = MatOut(double(MatOut(:,6))==double(selection), :); 
        Voxels2D = [Voxels(1), 1, Voxels(3)]; 
        metadata.metadata.Rows = Voxels(1); 
        metadata.metadata.Columns = Voxels(3); 
        PixSpac = [VoxelsDim(3) VoxelsDim(1)]; 



xvii 
 

        metadata.metadata.Width = Voxels(1); 
        metadata.metadata.Height = Voxels(3); 
    case 'yVoxIndex' 
        MatSelect = MatOut(MatOut(:,4)==selection, :); 
        Voxels2D = [Voxels(1), 1, Voxels(3)]; 
        metadata.metadata.Rows = Voxels(1); 
        metadata.metadata.Columns = Voxels(3); 
        PixSpac = [VoxelsDim(3) VoxelsDim(1)]; 
        metadata.metadata.Width = Voxels(1); 
        metadata.metadata.Height = Voxels(3); 
    case 'z' 
        MatSelect = MatOut(double(MatOut(:,9))==double(selection), :); 
        Voxels2D = [Voxels(1), Voxels(2), 1]; 
        metadata.metadata.Rows = Voxels(1); 
        metadata.metadata.Columns = Voxels(2); 
        PixSpac = [VoxelsDim(2) VoxelsDim(1)]; 
        metadata.metadata.Width = Voxels(1); 
        metadata.metadata.Height = Voxels(2); 
    case 'zVoxIndex' 
        MatSelect = MatOut(MatOut(:,7)==selection, :); 
        Voxels2D = [Voxels(1), Voxels(2), 1]; 
        metadata.metadata.Rows = Voxels(1); 
        metadata.metadata.Columns = Voxels(2); 
        PixSpac = [VoxelsDim(2) VoxelsDim(1)]; 
        metadata.metadata.Width = Voxels(1); 
        metadata.metadata.Height = Voxels(2); 
    otherwise 
        error('invalid selection') 
end 

  
metadata.metadata.Filename = inputAddress; 

  
size(MatSelect) 

  
MatSelect = reshape(MatSelect(:,10), Voxels2D); 
dicomwrite(imrotate(MatSelect, -90), saveAddress, metadata, 

'CreateMode', 'Copy', 'PixelSpacing', 10*PixSpac, 'SOPClassUID', 

'1.2.840.10008.5.1.4.1.1.2', 'MultiframeSingleFile', true); 

 

 

 

 


</field>
	</doc>
</add>